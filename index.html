<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/english-kunama/translations/main/37.jpg" type="image/png">
    <title>English ↔ Kunama Translation</title>

    <!-- CSS Styles --> 
    <style>
       /* Base styles */
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
            box-sizing: border-box;
            margin: 0;
            transition: background 0.3s ease;
        }

        /* Container styles */
        .container {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 100%;
            text-align: center;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        h2, h3 {
            color: #2a5298;
            font-size: 20px;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }

        /* Form element styles */
        .input-field {
            margin: 10px 0;
            padding: 12px;
            width: 90%;
            border: 2px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s ease, background 0.3s ease, color 0.3s ease;
        }

        /* Form area */
        #addFormContainer {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            position: relative;
            transition: background 0.3s ease;
        }

        /* Character Counter */
        .char-counter {
            display: block;
            text-align: right;
            color: #777;
            font-size: 12px;
            margin-top: -8px;
            margin-bottom: 10px;
            padding-right: 5%;
        }

        /* Auto-save indicator */
        .autosave-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.1);
            color: #555;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Button styles */
        .button {
            padding: 12px;
            width: 100%;
            margin: 10px 0;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
        }

        .button:hover {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            transform: translateY(-2px);
        }

        .button-secondary {
            background: linear-gradient(135deg, #808080, #a9a9a9);
        }

        .button-secondary:hover {
            background: linear-gradient(135deg, #a9a9a9, #808080);
        }

        .button-small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
        }

        #searchButton {
            display: none;
        }

        /* Results area */
        #results {
            margin-top: 20px;
            text-align: left;
        }

        .result-item {
            margin: 12px 0;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 8px;
            color: #333;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, transform 0.2s ease;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .result-content {
            flex: 1;
        }

        .result-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .copy-button, .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            color: #555;
            font-size: 18px;
            padding: 5px;
            margin-left: 8px;
        }

        .copy-button:hover, .tts-button:hover {
            color: #2575fc;
        }

        /* Modal dialog */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: #1c3d2b;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .confirm-details {
            background: #5f53e8;
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: left;
            transition: background 0.3s ease;
        }
        
        .confirm-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Search history styles */
        .history-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            position: absolute;
            right: 20px;
            top: 100px;
        }
        
        .search-history-container {
            position: absolute;
            top: 120px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
            width: 250px;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            transition: background 0.3s ease;
        }
        
        .search-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .history-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .history-actions {
            display: flex;
            gap: 5px;
        }
        
        .history-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        /* Recent translations styles */
        .recent-translations-container {
            margin-top: 30px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            text-align: left;
            transition: background 0.3s ease;
        }
        
        .recent-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }
        
        .recent-item:last-child {
            border-bottom: none;
        }
        
        .recent-date {
            color: #888;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }

        /* Leaderboard styles */
        .leaderboard-container {
            margin-top: 30px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            text-align: left;
            transition: background 0.3s ease;
        }
        
        .leaderboard-list {
            padding-left: 25px;
        }
        
        .leaderboard-list li {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        
        .contributor-name {
            font-weight: bold;
        }
        
        .contribution-count {
            color: #666;
        }

        /* Filter styles */
        .search-filter-container {
            margin-top: 10px;
            position: relative;
        }
        
        .filter-toggle {
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .filter-toggle:hover {
            background: #e0e0e0;
        }
        
        .filter-options {
            display: none;
            position: absolute;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
            margin-top: 10px;
            text-align: left;
            transition: background 0.3s ease;
        }
        
        .filter-group {
            margin-bottom: 12px;
        }
        
        .filter-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
        }
        
        .checkbox-group label {
            font-weight: normal;
        }
        
        /* Category tags */
        .category-tag {
            display: inline-block;
            background: #e0e0e0;
            color: #555;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            margin-top: 5px;
        }

        /* Pagination styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
        }
        
        .page-info {
            color: #666;
            font-size: 14px;
        }
        
        .pagination-buttons {
            display: flex;
            gap: 10px;
        }
        
        .pagination-button {
            background: #f0f0f0;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .pagination-button:hover {
            background: #e0e0e0;
        }

        /* Voting system styles */
        .vote-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
            gap: 5px;
        }
        
        .vote-label {
            font-size: 14px;
            color: #666;
        }
        
        .vote-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 3px 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .vote-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .vote-count {
            font-size: 12px;
            margin-left: 3px;
        }
        
        .vote-message {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 30px;
            right: 10px;
            animation: fadeInOut 2s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .notification.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .notification.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        /* Search suggestions */
        .search-suggestions {
            margin-top: 15px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 6px;
            transition: background 0.3s ease;
        }
        
        .search-suggestions p {
            margin: 0 0 5px 0;
            font-weight: bold;
        }
        
        .search-suggestions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .search-suggestions a {
            color: #2575fc;
            text-decoration: none;
        }
        
        .search-suggestions a:hover {
            text-decoration: underline;
        }

        /* Dark mode styles */
        .dark-mode-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 22px;
            color: #555;
            z-index: 5;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
        }
        
        body.dark-mode .container {
            background: #252525;
            color: #e0e0e0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode h2, 
        body.dark-mode h3 {
            color: #81a4ff;
        }
        
        body.dark-mode .input-field {
            background: #333;
            color: #e0e0e0;
            border-color: #444;
        }
        
        body.dark-mode .result-item,
        body.dark-mode #addFormContainer,
        body.dark-mode .recent-translations-container,
        body.dark-mode .leaderboard-container,
        body.dark-mode .filter-options,
        body.dark-mode .search-history-container,
        body.dark-mode .modal-content,
        body.dark-mode .search-suggestions,
        body.dark-mode #userProfileSection,
        body.dark-mode #authModal .modal-content {
            background: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .confirm-details {
            background: #3a3a3a;
        }
        
        body.dark-mode .recent-item {
            border-color: #444;
        }
        
        body.dark-mode .vote-label,
        body.dark-mode .recent-date,
        body.dark-mode .contribution-count,
        body.dark-mode .page-info {
            color: #aaa;
        }
        
        body.dark-mode .filter-toggle,
        body.dark-mode .pagination-button {
            background: #444;
            color: #e0e0e0;
        }
        
        body.dark-mode .filter-toggle:hover,
        body.dark-mode .pagination-button:hover {
            background: #555;
        }
        
        body.dark-mode .category-tag {
            background: #555;
            color: #e0e0e0;
        }
        
        body.dark-mode .history-item {
            border-color: #444;
        }
        
        body.dark-mode .dark-mode-toggle {
            color: #e0e0e0;
        }

        /* User profile styles */
        #userProfileSection {
            margin-top: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            text-align: left;
            transition: background 0.3s ease;
            display: none;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2a5298;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }
        
        .profile-name {
            font-weight: bold;
            font-size: 18px;
        }
        
        .profile-email {
            color: #666;
            font-size: 14px;
        }
        
        .profile-actions {
            margin-top: 10px;
        }

        /* User menu */
        .user-menu {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #2a5298;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .user-menu:hover {
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        body.dark-mode .user-menu {
            background: rgba(40, 40, 40, 0.9);
            color: #81a4ff;
        }
        
        body.dark-mode .user-menu:hover {
            background: #333;
        }

        /* Authentication modal */
        #authModal .modal-content {
            max-width: 400px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .auth-tab {
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 5px;
            border-bottom: 2px solid transparent;
        }
        
        .auth-tab.active {
            border-bottom: 2px solid #2a5298;
            font-weight: bold;
            color: #2a5298;
        }
        
        body.dark-mode .auth-tab.active {
            border-color: #81a4ff;
            color: #81a4ff;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .auth-form .input-field {
            width: 100%;
        }
        
        .auth-switch {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
        
        .auth-switch a {
            color: #2a5298;
            text-decoration: none;
            cursor: pointer;
        }
        
        body.dark-mode .auth-switch {
            color: #aaa;
        }
        
        body.dark-mode .auth-switch a {
            color: #81a4ff;
        }

        /* Contact us link */
        #contactUsLink {
            position: fixed;  
            bottom: 20px;  
            right: 20px;   
            font-size: 14px;  
            color: #fff;  
            background-color: rgba(0, 0, 0, 0.5);  
            padding: 8px 12px;  
            border-radius: 6px;  
            text-decoration: none;  
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);  
            transition: all 0.3s ease;  
        }
        
        #contactUsLink:hover {
            background-color: rgba(0, 0, 0, 0.8);  
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);  
        }

        /* Progress bar styles */
        #progressContainer {
            margin-top: 20px;
            text-align: center;
        }
        
        #progressBar {
            height: 20px;
            width: 0%;
            background-color: #4caf50;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        
        /* Navigation Bar Styles - NEW */
        .nav-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            margin: 0 5px;
            border-radius: 6px;
            background: #f0f0f0;
            color: #333;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .nav-item:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
        }
        
        body.dark-mode .nav-item {
            background: #444;
            color: #e0e0e0;
        }
        
        body.dark-mode .nav-item:hover {
            background: #555;
        }
        
        /* Content sections */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* Quiz Styles - NEW */
        #quizSection {
            text-align: center;
        }
        
        #quizInfo {
            margin: 20px 0;
        }
        
        #quizLoading {
            display: none;
            margin: 20px 0;
        }
        
        #difficultySelection {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .difficulty-button {
            padding: 8px 15px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .difficulty-button:hover {
            background: #f0f0f0;
        }
        
        .difficulty-button.selected {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            border-color: #2575fc;
        }
        
        #questionContainer {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        
        #quizProgress {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        #timerContainer {
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            color: #2a5298;
        }
        
        .timer-warning {
            color: #f44336;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        #questionType {
            font-size: 18px;
            color: #2a5298;
            margin-bottom: 5px;
        }
        
        #questionPrompt {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        #quizOptions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .quiz-option {
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 6px;
            background: white;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        .quiz-option:hover {
            background: #f0f0f0;
            border-color: #999;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .quiz-option.correct-answer {
            background-color: #E8F5E9;
            border-color: #4CAF50;
            color: #2E7D32;
            animation: correctAnswer 0.5s;
        }
        
        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .quiz-option.wrong-answer {
            background-color: #FFEBEE;
            border-color: #F44336;
            color: #C62828;
            animation: wrongAnswer 0.5s;
        }
        
        @keyframes wrongAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
        
        #questionFeedback {
            display: none;
            margin: 10px 0;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            border-radius: 6px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #nextButton {
            display: none;
            margin: 20px auto;
            max-width: 200px;
            transition: all 0.3s;
        }
        
        #nextButton:hover {
            transform: translateX(5px);
        }
        
        #quizFinished {
            display: none;
            margin: 20px 0;
            text-align: center;
            animation: bounceIn 0.7s;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        #quizScore {
            font-size: 30px;
            font-weight: bold;
            margin: 15px 0;
            color: #2a5298;
        }
        
        #quizFeedback {
            font-size: 20px;
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #streakCounter {
            font-size: 16px;
            margin: 10px 0;
            color: #ff9800;
            font-weight: bold;
        }
        
        #highScoreSection {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #highScoreValue {
            font-size: 20px;
            font-weight: bold;
            color: #ff9800;
        }
        
        body.dark-mode #quizOptions .quiz-option {
            background: #333;
            color: #e0e0e0;
            border-color: #444;
        }
        
        body.dark-mode #quizOptions .quiz-option:hover {
            background: #444;
            border-color: #555;
        }
        
        body.dark-mode .difficulty-button {
            background: #333;
            color: #e0e0e0;
            border-color: #444;
        }
        
        body.dark-mode .difficulty-button:hover {
            background: #444;
        }
        
        body.dark-mode #highScoreSection,
        body.dark-mode #quizFeedback {
            background-color: #333;
            color: #e0e0e0;
        }
        
        /* Responsive design */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                max-width: 95%;
            }
            
            .search-history-container {
                width: 200px;
                right: 10px;
            }
            
            .history-button {
                right: 10px;
            }
            
            .filter-options {
                position: fixed;
                left: 5%;
                right: 5%;
                top: 50%;
                transform: translateY(-50%);
            }
            
            .modal-content {
                width: 90%;
            }
            
            #contactUsLink {
                bottom: 10px;
                right: 10px;
            }
            
            .user-menu {
                padding: 5px 8px;
                font-size: 14px;
            }
            
            h2 {
                margin-top: 50px; /* Adds more space at the top to prevent overlap */
                font-size: 18px; /* Slightly smaller font size for mobile */
                padding: 0 10px; /* Adds some horizontal padding */
            }
            
            .nav-container {
                flex-wrap: wrap;
            }
            
            .nav-item {
                padding: 8px 12px;
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            #questionPrompt {
                font-size: 20px;
            }
            
            .quiz-option {
                padding: 10px;
                font-size: 14px;
            }
            
            #quizScore {
                font-size: 24px;
            }
        }
		/* Navigation additions */
    .nav-container {
        position: relative;
    }
    
    .nav-item.has-badge::after {
        content: '';
        position: absolute;
        top: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background: #FF5722;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    
    /* User Stats Panel */
    .user-stats-panel {
        display: flex;
        justify-content: space-around;
        margin: 10px 0 20px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .stats-item {
        text-align: center;
    }
    
    .stats-icon {
        font-size: 24px;
        margin-bottom: 5px;
    }
    
    .stats-value {
        font-size: 22px;
        font-weight: bold;
        color: #2a5298;
    }
    
    .stats-label {
        font-size: 12px;
        color: #666;
    }
    
    body.dark-mode .stats-value {
        color: #81a4ff;
    }
    
    body.dark-mode .stats-label {
        color: #aaa;
    }
    
    /* Daily Challenge Styles */
    .challenge-container {
        margin: 20px 0;
        padding: 15px;
        background: #f8f8f8;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    body.dark-mode .challenge-container {
        background: #333;
    }
    
    .challenge-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }
    
    body.dark-mode .challenge-header {
        border-color: #555;
    }
    
    .challenge-day {
        font-weight: bold;
        color: #6a11cb;
    }
    
    .challenge-date {
        color: #666;
    }
    
    body.dark-mode .challenge-day {
        color: #a56eff;
    }
    
    body.dark-mode .challenge-date {
        color: #aaa;
    }
    
    .challenge-card {
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    
    body.dark-mode .challenge-card {
        background: #3a3a3a;
    }
    
    .challenge-type {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
    }
    
    .challenge-prompt {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    
    .challenge-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .challenge-option {
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }
    
    .challenge-option:hover {
        border-color: #2575fc;
        background: #f0f7ff;
        transform: translateY(-2px);
    }
    
    .challenge-option.selected {
        border-color: #2575fc;
        background: #e6f0ff;
    }
    
    .challenge-option.correct {
        border-color: #4CAF50;
        background: #E8F5E9;
    }
    
    .challenge-option.incorrect {
        border-color: #F44336;
        background: #FFEBEE;
    }
    
    body.dark-mode .challenge-option {
        background: #444;
        border-color: #555;
    }
    
    body.dark-mode .challenge-option:hover {
        background: #505050;
        border-color: #81a4ff;
    }
    
    body.dark-mode .challenge-option.selected {
        background: #3a4a6a;
        border-color: #81a4ff;
    }
    
    body.dark-mode .challenge-option.correct {
        background: #1b5e20;
        border-color: #4CAF50;
    }
    
    body.dark-mode .challenge-option.incorrect {
        background: #b71c1c;
        border-color: #F44336;
    }
    
    .challenge-input {
        margin-bottom: 20px;
    }
    
    .challenge-feedback {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .challenge-feedback.correct {
        background: #E8F5E9;
        color: #2E7D32;
    }
    
    .challenge-feedback.incorrect {
        background: #FFEBEE;
        color: #C62828;
    }
    
    body.dark-mode .challenge-feedback.correct {
        background: #1b5e20;
        color: #E8F5E9;
    }
    
    body.dark-mode .challenge-feedback.incorrect {
        background: #b71c1c;
        color: #FFEBEE;
    }
    
    .challenge-footer {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    
    .streak-container, .points-container {
        text-align: center;
    }
    
    .streak-label, .points-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .streak-value, .points-value {
        font-size: 18px;
        font-weight: bold;
        color: #2a5298;
    }
    
    body.dark-mode .streak-label, 
    body.dark-mode .points-label {
        color: #aaa;
    }
    
    body.dark-mode .streak-value, 
    body.dark-mode .points-value {
        color: #81a4ff;
    }
    
    .completion-message {
        text-align: center;
        padding: 20px;
        background: #f0f7ff;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    body.dark-mode .completion-message {
        background: #3a4a6a;
    }
    
    .achievement-container {
        text-align: center;
        padding: 15px;
        background: #FFF8E1;
        border-radius: 10px;
        margin: 20px 0;
        animation: scaleIn 0.5s ease-out;
    }
    
    body.dark-mode .achievement-container {
        background: #614a19;
    }
    
    @keyframes scaleIn {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    .achievement {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .achievement-icon {
        font-size: 40px;
        margin-bottom: 10px;
    }
    
    .achievement-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .achievement-description {
        font-size: 14px;
        color: #666;
    }
    
    body.dark-mode .achievement-description {
        color: #bbb;
    }
    
    .achievements-section {
        margin-top: 30px;
    }
    
    .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .achievement-card {
        padding: 15px;
        border-radius: 10px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .achievement-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .achievement-card.locked {
        opacity: 0.5;
        filter: grayscale(1);
    }
    
    body.dark-mode .achievement-card {
        background: #3a3a3a;
    }
    
    /* Enhanced Quiz Styles */
    .quiz-variation-selector {
        margin: 15px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    
    .quiz-type-button {
        padding: 10px 15px;
        background: #f0f0f0;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .quiz-type-button:hover {
        background: #e0e0e0;
        transform: translateY(-2px);
    }
    
    .quiz-type-button.active {
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
        border-color: #2575fc;
    }
    
    body.dark-mode .quiz-type-button {
        background: #444;
        border-color: #555;
    }
    
    body.dark-mode .quiz-type-button:hover {
        background: #505050;
    }
    
    /* Sentence Completion Quiz */
    .sentence-completion {
        font-size: 20px;
        margin: 20px 0;
        line-height: 1.6;
    }
    
    .blank-space {
        display: inline-block;
        min-width: 100px;
        border-bottom: 2px solid #2575fc;
        margin: 0 5px;
        padding: 0 5px;
        text-align: center;
    }
    
    /* Image matching quiz */
    .image-container {
        max-width: 250px;
        height: 200px;
        margin: 0 auto 20px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    .quiz-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Listening quiz */
    .listening-controls {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
    
    .play-button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #2575fc;
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
    }
    
    .play-button:hover {
        background: #1a66e0;
        transform: scale(1.05);
    }
    
    /* Gamification Styles */
    .level-indicator {
        display: flex;
        align-items: center;
        margin: 10px 0;
        padding: 10px;
        background: #f0f7ff;
        border-radius: 8px;
    }
    
    body.dark-mode .level-indicator {
        background: #3a4a6a;
    }
    
    .level-badge {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
        border-radius: 50%;
        font-weight: bold;
        margin-right: 15px;
    }
    
    .level-info {
        flex: 1;
    }
    
    .level-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .level-description {
        font-size: 12px;
        color: #666;
    }
    
    body.dark-mode .level-description {
        color: #aaa;
    }
    
    .progress-container {
        margin-top: 5px;
        width: 100%;
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #6a11cb, #2575fc);
        border-radius: 5px;
        transition: width 0.5s ease;
    }
    
    body.dark-mode .progress-container {
        background: #555;
    }
    
    /* Word of the Day */
    .word-of-day {
        margin: 20px 0;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 10px;
        text-align: center;
    }
    
    body.dark-mode .word-of-day {
        background: #3a3a3a;
    }
    
    .word-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .word-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .word-translation {
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    .word-context {
        font-style: italic;
        margin-top: 10px;
        font-size: 14px;
        color: #666;
    }
    
    body.dark-mode .word-label,
    body.dark-mode .word-context {
        color: #aaa;
    }
    
    /* Point Activity Feed */
    .points-activity {
        margin-top: 20px;
    }
    
    .activity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin-bottom: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .activity-item:hover {
        background: #f0f0f0;
    }
    
    body.dark-mode .activity-item {
        background: #3a3a3a;
    }
    
    body.dark-mode .activity-item:hover {
        background: #444;
    }
    
    .activity-description {
        flex: 1;
    }
    
    .activity-points {
        font-weight: bold;
        color: #4CAF50;
    }
    
    .activity-date {
        font-size: 12px;
        color: #888;
    }
    
    body.dark-mode .activity-date {
        color: #aaa;
    }
    
    /* Animation for new features */
    .new-feature {
        position: relative;
    }
    
    .new-feature::after {
        content: 'NEW';
        position: absolute;
        top: -10px;
        right: -10px;
        background: #FF5722;
        color: white;
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 10px;
        font-weight: bold;
    }
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
        .user-stats-panel {
            padding: 5px;
        }
        
        .stats-icon {
            font-size: 20px;
        }
        
        .stats-value {
            font-size: 18px;
        }
        
        .stats-label {
            font-size: 10px;
        }
        
        .challenge-prompt {
            font-size: 18px;
        }
        
        .challenge-footer {
            flex-direction: column;
            gap: 10px;
        }
        
        .achievements-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        
        .quiz-variation-selector {
            flex-direction: column;
        }
    }

    /* Play menu styles */
    .play-menu {
        position: absolute;
        top: 125px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 500px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 100;
        padding: 15px;
        transition: all 0.3s ease;
        display: none;
    }
    
    .play-option {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .play-option:hover {
        background: #f0f7ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .play-option-icon {
        font-size: 24px;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: rgba(42, 82, 152, 0.1);
        border-radius: 50%;
    }
    
    .play-option-content {
        flex: 1;
    }
    
    .play-option-title {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .play-option-description {
        font-size: 14px;
        color: #666;
    }
    
    body.dark-mode .play-menu {
        background: #333;
    }
    
    body.dark-mode .play-option:hover {
        background: #3a4a6a;
    }
    
    body.dark-mode .play-option-description {
        color: #aaa;
    }

    /* Multiplayer section styles */
    #multiplayerSection {
        text-align: center;
    }
    
    .multiplayer-container {
        margin: 20px 0;
        padding: 20px;
        background: #f8f8f8;
        border-radius: 10px;
    }
    
    .connection-status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .connection-status.online {
        background: #E8F5E9;
        color: #2E7D32;
    }
    
    .connection-status.offline {
        background: #FFEBEE;
        color: #C62828;
    }
    
    .mp-actions {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
    }
    
    .mp-action-button {
        min-width: 150px;
    }
    
    .mp-game-code {
        font-size: 24px;
        font-weight: bold;
        letter-spacing: 2px;
        margin: 15px 0;
        padding: 10px;
        background: #f0f7ff;
        border-radius: 6px;
        display: inline-block;
    }
    
    .mp-status-message {
        margin: 15px 0;
        font-size: 18px;
        color: #2a5298;
    }
    
    .mp-waiting {
        margin: 20px 0;
    }
    
    .mp-waiting-animation {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>
</head>

<body>
    <div class="container">
        <!-- User menu button -->
        <button id="userMenuBtn" class="user-menu">
            <span id="userIcon">👤</span>
            <span id="userName">Sign in</span>
        </button>
        
        <h2>🔎 English ↔ Kunama Translation</h2>
        
        <!-- Navigation Bar - NEW -->
        <div class="nav-container">
            <div id="navSearch" class="nav-item active">Search</div>
            <div id="navAdd" class="nav-item">Add New</div>
            <div id="navQuiz" class="nav-item">Games</div>
            <div id="navLeaderboard" class="nav-item">Leaderboard</div>
        </div>
        
        <!-- Search & Results Section -->
        <div id="searchSection" class="content-section active">
            <input type="text" id="searchInput" class="input-field" placeholder="Start typing...">
            <div id="results"></div>
            <div id="statusMessage"></div>
            
            <!-- Progress bar -->
            <div id="progressContainer">
                <p id="progressText">0/5000 submissions needed from users (0%)</p>
                <div style="background-color: #ccc; border-radius: 5px; height: 20px; width: 100%;">
                    <div id="progressBar"></div>
                </div>
            </div>
            
            <!-- Recent translations container -->
            <div id="recentTranslations" class="recent-translations-container">
                <h3>Recently Added</h3>
                <p>Loading recent translations...</p>
            </div>
        </div>
        
        <!-- Add New Section -->
        <div id="addSection" class="content-section">
            <h3>Add New Translation</h3>
            <div>
                <input type="text" id="newPhrase" class="input-field" placeholder="English here...">
                <input type="text" id="newTranslation" class="input-field" placeholder="Kunama here...">
                <select id="newCategory" class="input-field">
                    <option value="">Select category (optional)</option>
                    <option value="greetings">Greetings</option>
                    <option value="food">Food</option>
                    <option value="family">Family</option>
                    <option value="numbers">Numbers</option>
                    <option value="common">Common Phrases</option>
                </select>
                <button id="addPhraseButton" class="button">Add (Itafe)</button>
            </div>
        </div>
        
        <!-- Quiz Section - NEW -->
        <div id="quizSection" class="content-section">
            <h3>Test Your Kunama Knowledge</h3>
            
            <div id="quizInfo">
                <p>Test your knowledge of Kunama words and phrases with this interactive quiz!</p>
                
                <div id="difficultySelection">
                    <p>Select difficulty:</p>
                    <button class="difficulty-button" onclick="window.setDifficulty('easy')">Easy</button>
                    <button class="difficulty-button selected" onclick="window.setDifficulty('medium')">Medium</button>
                    <button class="difficulty-button" onclick="window.setDifficulty('hard')">Hard</button>
                </div>
                
                <button id="startQuizButton" onclick="window.startQuiz()" class="button">Start Quiz</button>
            </div>
            
            <div id="quizLoading">
                <p>Loading quiz questions...</p>
            </div>
            
            <div id="questionContainer">
                <div id="quizProgress">Question 1 of 10</div>
                <div id="timerContainer">Time: <span id="timer">15</span>s</div>
                <div id="streakCounter">Current streak: 0</div>
                <div id="questionType">English to Kunama</div>
                <div id="questionPrompt">Translation for: Hello</div>
                
                <div id="quizOptions">
                    <!-- Options will be inserted here -->
                </div>
                
                <div id="questionFeedback"></div>
                <button id="nextButton" onclick="window.nextQuestion()" class="button">Next Question</button>
            </div>
            
            <div id="quizFinished">
                <h3>Quiz Complete!</h3>
                <p>Your score:</p>
                <div id="quizScore">7/10 (70%)</div>
                <div id="quizFeedback">Great job! You're getting very good at Kunama!</div>
                
                <div id="highScoreSection">
                    <p>Your High Score:</p>
                    <div id="highScoreValue">0%</div>
                </div>
                
                <button onclick="window.startQuiz()" class="button">Try Again</button>
            </div>
        </div>
        
        <!-- Leaderboard Section -->
        <div id="leaderboardSection" class="content-section">
            <h3>Top Contributors</h3>
            <div id="contributorLeaderboard" class="leaderboard-container">
                <p>Loading leaderboard...</p>
            </div>
        </div>
        
        <!-- Daily Challenge Section -->
        <div id="dailyChallengeSection" class="content-section">
            <h3>Daily Challenge</h3>
            
            <div id="challengeContainer" class="challenge-container">
                <div id="challengeLoading" style="display: none;">
                    <p>Loading today's challenge...</p>
                </div>
                
                <div id="challengeContent">
                    <div class="challenge-header">
                        <div class="challenge-day">Day <span id="challengeStreak">1</span></div>
                        <div class="challenge-date" id="challengeDate">April 5, 2025</div>
                    </div>
                    
                    <div class="challenge-card">
                        <div class="challenge-type" id="challengeType">Translation Challenge</div>
                        <div class="challenge-prompt" id="challengePrompt">How would you say "Hello" in Kunama?</div>
                        
                        <div id="challengeOptions" class="challenge-options">
                            <!-- Options will be filled dynamically -->
                        </div>
                        
                        <div id="challengeInput" class="challenge-input" style="display: none;">
                            <input type="text" id="userAnswer" class="input-field" placeholder="Type your answer here...">
                        </div>
                        
                        <button id="checkAnswerBtn" class="button">Check Answer</button>
                    </div>
                    
                    <div id="challengeFeedback" class="challenge-feedback" style="display: none;">
                        <!-- Feedback will be shown here -->
                    </div>
                    
                    <div class="challenge-footer">
                        <div class="streak-container">
                            <div class="streak-label">Current Streak</div>
                            <div class="streak-value"><span id="userStreak">0</span> days</div>
                        </div>
                        
                        <div class="points-container">
                            <div class="points-label">Total Points</div>
                            <div class="points-value"><span id="userPoints">0</span> pts</div>
                        </div>
                    </div>
                </div>
                
                <div id="challengeComplete" style="display: none;">
                    <div class="completion-message">
                        <h3>🎉 Challenge Completed!</h3>
                        <p>You've completed today's challenge and earned <span id="pointsEarned">10</span> points!</p>
                        <p>Come back tomorrow for a new challenge.</p>
                    </div>
                    
                    <div class="achievement-container" id="achievementContainer" style="display: none;">
                        <h4>🏆 Achievement Unlocked!</h4>
                        <div class="achievement" id="achievementEarned">
                            <!-- Achievement details will be filled here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="achievements-section">
                <h3>Your Achievements</h3>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- Achievements will be filled dynamically -->
                </div>
            </div>
        </div>
        
        <!-- User profile section -->
        <div id="userProfileSection">
            <h3>Your Profile</h3>
            <div class="profile-info">
                <div class="profile-avatar" id="profileAvatar">?</div>
                <div>
                    <div class="profile-name" id="profileName">Anonymous</div>
                    <div class="profile-email" id="profileEmail"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="displayNameInput">Display Name for Contributions:</label>
                <input type="text" id="displayNameInput" class="input-field" placeholder="Enter your preferred display name">
            </div>
            <div class="profile-actions">
                <button id="saveProfileBtn" class="button">Save Profile</button>
                <button id="signOutBtn" class="button button-secondary">Sign Out</button>
            </div>
        </div>
        
        <!-- User Stats Panel -->
        <div id="userStats" class="user-stats-panel">
            <div class="stats-item">
                <div class="stats-icon">🔥</div>
                <div class="stats-value" id="statStreak">0</div>
                <div class="stats-label">Day Streak</div>
            </div>
            <div class="stats-item">
                <div class="stats-icon">⭐</div>
                <div class="stats-value" id="statPoints">0</div>
                <div class="stats-label">Points</div>
            </div>
            <div class="stats-item">
                <div class="stats-icon">🏆</div>
                <div class="stats-value" id="statAchievements">0</div>
                <div class="stats-label">Achievements</div>
            </div>
        </div>
    </div>
    
    <!-- Authentication Modal -->
    <div id="authModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Sign In or Sign Up</h3>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="signin">Sign In</div>
                <div class="auth-tab" data-tab="signup">Sign Up</div>
            </div>
            
            <!-- Sign In Form -->
            <div id="signinForm" class="auth-form active">
                <div class="form-group">
                    <label for="signinEmail">Email:</label>
                    <input type="email" id="signinEmail" class="input-field" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signinPassword">Password:</label>
                    <input type="password" id="signinPassword" class="input-field" placeholder="Enter your password">
                </div>
                <button id="signinBtn" class="button">Sign In</button>
                <div class="auth-switch">
                    Don't have an account? <a id="switchToSignup">Sign up</a>
                </div>
                <div class="auth-switch">
                    Or <a id="continueAnonymously">continue anonymously</a>
                </div>
            </div>
            
            <!-- Sign Up Form -->
            <div id="signupForm" class="auth-form">
                <div class="form-group">
                    <label for="signupName">Display Name:</label>
                    <input type="text" id="signupName" class="input-field" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" class="input-field" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" class="input-field" placeholder="Enter your password">
                </div>
                <button id="signupBtn" class="button">Sign Up</button>
                <div class="auth-switch">
                    Already have an account? <a id="switchToSignin">Sign in</a>
                </div>
                <div class="auth-switch">
                    Or <a id="continueAnonymously2">continue anonymously</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Contact link -->
    <a href="https://www.facebook.com/NativeEritrean" target="_blank" id="contactUsLink">Contact Us</a>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, query, get, orderByChild, orderByKey, equalTo, limitToLast, update, remove, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDyOgYzDMZdo5V21T8fgHTvPhfgIavuxBA",
            authDomain: "kunama-academy-data.firebaseapp.com",
            databaseURL: "https://kunama-academy-data-default-rtdb.firebaseio.com",
            projectId: "kunama-academy-data",
            storageBucket: "kunama-academy-data.firebasestorage.app",
            messagingSenderId: "1089407925060",
            appId: "1:1089407925060:web:260a1f597ed520fc977511"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        // Authentication state
        let currentUser = null;
        let isAnonymous = true;
        
        // Global quiz variables
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentStreak = 0;
        let highScore = 0;
        let selectedDifficulty = "medium"; // Default difficulty
        let timerValue = 15; // Default timer value in seconds
        let timerInterval; // For the timer
        
        // Competition variables
        let competitionRoomId = null;
        let playerRole = null;
        let competitionQuestions = [];
        let competitionTimer = null;
        let opponentId = null;

        // ==================== NAVIGATION FUNCTIONALITY - NEW ====================
        
        function setupNavigation() {
            // Get all navigation items and content sections
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            // Add click event to each nav item
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active class from all nav items and content sections
                    navItems.forEach(nav => nav.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));
                    
                    // Add active class to clicked nav item
                    item.classList.add('active');
                    
                    // Show corresponding content section
                    let sectionId = '';
                    if (item.id === 'navSearch') sectionId = 'searchSection';
                    else if (item.id === 'navAdd') sectionId = 'addSection';
                    else if (item.id === 'navQuiz') sectionId = 'quizSection';
                    else if (item.id === 'navLeaderboard') sectionId = 'leaderboardSection';
                    
                    document.getElementById(sectionId).classList.add('active');
                });
            });
        }

        // ==================== QUIZ FUNCTIONALITY - NEW ====================
        // Function to set difficulty
        function setDifficulty(difficulty) {
            selectedDifficulty = difficulty;
            
            // Update UI
            document.querySelectorAll('.difficulty-button').forEach(button => {
                button.classList.remove('selected');
            });
            
            document.querySelector(`.difficulty-button:nth-of-type(${
                difficulty === 'easy' ? 1 : difficulty === 'medium' ? 2 : 3
            })`).classList.add('selected');
            
            // Set timer based on difficulty
            if (difficulty === 'easy') {
                timerValue = 30; // 30 seconds for easy
            } else if (difficulty === 'medium') {
                timerValue = 15; // 15 seconds for medium
            } else {
                timerValue = 10; // 10 seconds for hard
            }
            
            document.getElementById('timer').innerText = timerValue;
        }

        // Function to add quit button to the question container
        function addQuitButton() {
            const questionContainer = document.getElementById("questionContainer");
            
            // Check if quit button already exists to avoid duplicates
            if (!document.getElementById("quitQuizButton")) {
                const quitButtonContainer = document.createElement("div");
                quitButtonContainer.style.marginTop = "20px";
                quitButtonContainer.style.textAlign = "center";
                
                const quitButton = document.createElement("button");
                quitButton.id = "quitQuizButton";
                quitButton.className = "button button-secondary";
                quitButton.style.maxWidth = "200px";
                quitButton.textContent = "Quit Quiz";
                quitButton.onclick = quitQuiz;
                
                quitButtonContainer.appendChild(quitButton);
                questionContainer.appendChild(quitButtonContainer);
            }
        }

        // Function to handle quitting the quiz
        function quitQuiz() {
            // Stop any running timer
            clearInterval(timerInterval);
            
            // Show confirmation dialog
            if (confirm("Are you sure you want to quit this quiz? Your progress will be lost.")) {
                // Reset quiz state
                quizQuestions = [];
                currentQuestionIndex = 0;
                score = 0;
                currentStreak = 0;
                
                // Hide quiz-related containers
                document.getElementById("questionContainer").style.display = "none";
                document.getElementById("quizFinished").style.display = "none";
                document.getElementById("quizLoading").style.display = "none";
                
                // Show the quiz info section
                document.getElementById("quizInfo").style.display = "block";
                
                // Go back to the search tab/home page
                document.getElementById('navSearch').click();
                
                // Show notification
                showNotification("Quiz exited", "success");
            } else {
                // If user cancels, restart the timer
                startTimer();
            }
        }

        // Function to start a new quiz
        async function startQuiz() {
            // Show loading indicator and reset display states
            document.getElementById("quizInfo").style.display = "none";
            document.getElementById("quizLoading").style.display = "block";
            document.getElementById("questionContainer").style.display = "none";
            document.getElementById("quizFinished").style.display = "none";
            
            // Reset quiz state
            quizQuestions = [];
            currentQuestionIndex = 0;
            score = 0;
            currentStreak = 0;
            
            try {
                // Get approved phrases from Firebase - ONLY from approved_phrases
                const approvedPhrasesRef = ref(db, 'approved_phrases');
                console.log("Fetching data from 'approved_phrases'");
                
                const snapshot = await get(approvedPhrasesRef);
                
                // Check if we have any data
                if (!snapshot.exists() || snapshot.size === 0) {
                    console.log("No data found in 'approved_phrases'");
                    document.getElementById("quizLoading").style.display = "none";
                    document.getElementById("quizInfo").style.display = "block";
                    document.getElementById("quizInfo").innerHTML = `
                        <p>No approved phrases found in the database to create quiz questions.</p>
                        <p>Please wait for submissions to be approved before trying the quiz.</p>
                        <button class="button" onclick="document.getElementById('navSearch').click()">Return to Search</button>
                    `;
                    return;
                }
                
                // Process the data
                const allPhrases = [];
                snapshot.forEach(childSnapshot => {
                    const phraseData = childSnapshot.val();
                    
                    // Make sure the entry has both phrase and translation fields
                    if (phraseData.phrase && phraseData.translation) {
                        allPhrases.push(phraseData);
                    }
                });
                
                // We need at least 4 phrases for a quiz with options
                if (allPhrases.length >= 4) {
                    // Shuffle array using Fisher-Yates algorithm
                    for (let i = allPhrases.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [allPhrases[i], allPhrases[j]] = [allPhrases[j], allPhrases[i]];
                    }
                    
                    // Take first 10 phrases or fewer if not enough
                    const questionCount = Math.min(10, allPhrases.length);
                    
                    // Prepare quiz questions
                    for (let i = 0; i < questionCount; i++) {
                        // Decide randomly if we're testing English to Kunama or Kunama to English
                        const isEnglishToKunama = Math.random() > 0.5;
                        
                        const correctAnswer = allPhrases[i];
                        
                        // Determine correct answer text based on direction
                        const correctAnswerText = isEnglishToKunama ? correctAnswer.translation : correctAnswer.phrase;
                        
                        // Initialize options array with correct answer
                        let options = [correctAnswerText];
                        
                        // Get 3 random incorrect options
                        let attemptCount = 0;
                        while (options.length < 4 && attemptCount < 20) {
                            attemptCount++;
                            const randomIndex = Math.floor(Math.random() * allPhrases.length);
                            const randomOption = isEnglishToKunama ? 
                                allPhrases[randomIndex].translation : 
                                allPhrases[randomIndex].phrase;
                            
                            // Make sure we don't add duplicates
                            if (!options.includes(randomOption) && randomOption !== correctAnswerText) {
                                options.push(randomOption);
                            }
                        }
                        
                        // If we couldn't get enough options, fill with dummy options
                        while (options.length < 4) {
                            options.push(`Option ${options.length + 1}`);
                        }
                        
                        // Shuffle options
                        for (let j = options.length - 1; j > 0; j--) {
                            const k = Math.floor(Math.random() * (j + 1));
                            [options[j], options[k]] = [options[k], options[j]];
                        }
                        
                        // Create question object
                        const question = {
                            prompt: isEnglishToKunama ? correctAnswer.phrase : correctAnswer.translation,
                            options: options,
                            correctAnswer: correctAnswerText,
                            isEnglishToKunama: isEnglishToKunama
                        };
                        
                        quizQuestions.push(question);
                    }
                    
                    // Start showing questions
                    showQuestion();
                } else {
                    document.getElementById("quizLoading").style.display = "none";
                    document.getElementById("quizInfo").style.display = "block";
                    document.getElementById("quizInfo").innerHTML = `
                        <p>Not enough phrases available for a quiz. At least 4 phrases are needed.</p>
                        <p>Currently found: ${allPhrases.length} usable phrase(s).</p>
                        <button class="button" onclick="document.getElementById('navSearch').click()">Return to Search</button>
                    `;
                }
            } catch (error) {
                console.error("Error fetching phrases for quiz:", error);
                document.getElementById("quizLoading").style.display = "none";
                document.getElementById("quizInfo").style.display = "block";
                document.getElementById("quizInfo").innerHTML = `
                    <p>❌ Error loading quiz data: ${error.message}</p>
                    <p>Please check the browser console for more details.</p>
                    <button class="button" onclick="document.getElementById('navSearch').click()">Return to Search</button>
                `;
            }
        }

        // Function to start the timer
        function startTimer() {
            // Clear any existing timer
            clearInterval(timerInterval);
            
            let timeLeft = timerValue;
            document.getElementById('timer').innerText = timeLeft;
            document.getElementById('timer').classList.remove('timer-warning');
            
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                
                // Add warning class when time is running out
                if (timeLeft <= 5) {
                    document.getElementById('timer').classList.add('timer-warning');
                }
                
                // Time's up
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimerExpired();
                }
            }, 1000);
        }

        // Function to handle timer expiry
        function handleTimerExpired() {
            // Disable all options
            const optionButtons = document.querySelectorAll(".quiz-option");
            optionButtons.forEach(button => {
                button.disabled = true;
                
                // Highlight correct answer
                if (button.innerText === quizQuestions[currentQuestionIndex].correctAnswer) {
                    button.classList.add("correct-answer");
                }
            });
            
            // Reset streak
            currentStreak = 0;
            document.getElementById('streakCounter').innerText = `Current streak: ${currentStreak}`;
            
            // Show feedback
            const feedback = document.getElementById("questionFeedback");
            feedback.innerText = "⏱️ Time's up! You didn't answer in time.";
            feedback.style.color = "#F44336";
            feedback.style.backgroundColor = "#FFEBEE";
            feedback.style.display = "block";
            
            // Show next button
            document.getElementById("nextButton").style.display = "block";
        }

        // Function to display the current question
        function showQuestion() {
            document.getElementById("quizLoading").style.display = "none";
            
            if (currentQuestionIndex >= quizQuestions.length) {
                // Quiz is finished
                finishQuiz();
                return;
            }
            
            const question = quizQuestions[currentQuestionIndex];
            const questionType = question.isEnglishToKunama ? "English to Kunama" : "Kunama to English";
            
            // Update progress
            document.getElementById("quizProgress").innerText = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
            
            // Update streak counter
            document.getElementById("streakCounter").innerText = `Current streak: ${currentStreak}`;
            
            // Set question
            document.getElementById("questionType").innerText = questionType;
            document.getElementById("questionPrompt").innerText = question.prompt;
            
            // Clear previous options
            const optionsContainer = document.getElementById("quizOptions");
            optionsContainer.innerHTML = "";
            
            // Add new options
            question.options.forEach((option, index) => {
                optionsContainer.innerHTML += `
                    <button class="quiz-option" onclick="window.checkAnswer(${index})">${option}</button>
                `;
            });
            
            // Reset and start the timer
            startTimer();
            
            // Reset feedback and show the question container
            document.getElementById("questionFeedback").style.display = "none";
            document.getElementById("questionContainer").style.display = "block";
            
            // Add the quit button
            addQuitButton();
        }

        // Function to check the selected answer
        function checkAnswer(selectedIndex) {
            // Stop the timer
            clearInterval(timerInterval);
            
            const question = quizQuestions[currentQuestionIndex];
            const selectedOption = question.options[selectedIndex];
            const isCorrect = selectedOption === question.correctAnswer;
            
            // Disable all option buttons
            const optionButtons = document.querySelectorAll(".quiz-option");
            optionButtons.forEach(button => {
                button.disabled = true;
                
                // Highlight the correct answer
                if (button.innerText === question.correctAnswer) {
                    button.classList.add("correct-answer");
                }
                
                // If this is the selected wrong answer, highlight it
                if (button.innerText === selectedOption && !isCorrect) {
                    button.classList.add("wrong-answer");
                }
            });
            
            // Update score if correct
            if (isCorrect) {
                score++;
                currentStreak++;
                
                // Give bonus points for fast answers in hard mode
                if (selectedDifficulty === 'hard' && parseInt(document.getElementById('timer').innerText) > timerValue/2) {
                    score++; // Bonus point for fast answer in hard mode
                }
            } else {
                // Reset streak on wrong answer
                currentStreak = 0;
            }
            
            // Update streak counter
            document.getElementById("streakCounter").innerText = `Current streak: ${currentStreak}`;
            
            // Show feedback
            const feedback = document.getElementById("questionFeedback");
            if (isCorrect) {
                let feedbackText = "✅ Correct!";
                
                // Add streak message if streak is at least 3
                if (currentStreak >= 3) {
                    feedbackText += ` 🔥 ${currentStreak} in a row!`;
                }
                
                // Add bonus point message if in hard mode and answered quickly
                if (selectedDifficulty === 'hard' && parseInt(document.getElementById('timer').innerText) > timerValue/2) {
                    feedbackText += " +1 bonus point for quick answer!";
                }
                
                feedback.innerText = feedbackText;
                feedback.style.color = "#4CAF50";
                feedback.style.backgroundColor = "#E8F5E9";
            } else {
                feedback.innerText = `❌ Incorrect. The correct answer is: ${question.correctAnswer}`;
                feedback.style.color = "#C62828";
                feedback.style.backgroundColor = "#FFEBEE";
            }
            feedback.style.display = "block";
            
            // Show next button
            document.getElementById("nextButton").style.display = "block";
        }

        // Function to move to the next question
        function nextQuestion() {
            // Reset feedback and next button
            document.getElementById("questionFeedback").style.display = "none";
            document.getElementById("nextButton").style.display = "none";
            
            // Move to next question
            currentQuestionIndex++;
            showQuestion();
        }

        // Function to update high score
        function updateHighScore() {
            const percentage = Math.round((score / quizQuestions.length) * 100);
            
            // Get existing high score from localStorage or default to 0
            const existingHighScore = localStorage.getItem('kunamaQuizHighScore') || 0;
            
            // Update if current score is higher
            if (percentage > existingHighScore) {
                highScore = percentage;
                localStorage.setItem('kunamaQuizHighScore', highScore);
                
                // Show congratulations message if it's a new high score
                if (existingHighScore > 0) {
                    document.getElementById('highScoreValue').innerHTML = 
                        `${highScore}% <span style="color: #4CAF50; font-size: 14px;">(New Record!)</span>`;
                } else {
                    document.getElementById('highScoreValue').innerText = `${highScore}%`;
                }
            } else {
                highScore = existingHighScore;
                document.getElementById('highScoreValue').innerText = `${highScore}%`;
            }
        }

        // Function to finish the quiz
        function finishQuiz() {
            // Stop any running timer
            clearInterval(timerInterval);
            
            // Hide question container and show results
            document.getElementById("questionContainer").style.display = "none";
            document.getElementById("quizFinished").style.display = "block";
            
            // Calculate final score with potential bonus points
            const totalQuestions = quizQuestions.length;
            const possiblePoints = selectedDifficulty === 'hard' ? totalQuestions * 2 : totalQuestions;
            const percentage = Math.round((score / possiblePoints) * 100);
            
            // Display score with appropriate label
            let scoreDisplay = `${score} / ${totalQuestions}`;
            if (selectedDifficulty === 'hard') {
                scoreDisplay += ` (with bonus points: ${score}/${possiblePoints})`;
            }
            scoreDisplay += ` (${percentage}%)`;
            document.getElementById("quizScore").innerText = scoreDisplay;
            
            // Give feedback based on score percentage and difficulty
            let feedbackMessage;
            if (percentage >= 90) {
                if (selectedDifficulty === 'hard') {
                    feedbackMessage = "🏆 Incredible! You're a true Kunama language expert! 🎓";
                } else {
                    feedbackMessage = "🌟 Excellent! You're a Kunama master! 🎓";
                }
            } else if (percentage >= 70) {
                feedbackMessage = "🎯 Great job! You're getting very good at Kunama! 👍";
            } else if (percentage >= 50) {
                feedbackMessage = "💪 Good effort! Keep practicing to improve.";
            } else {
                feedbackMessage = "📚 Keep learning! Practice makes perfect.";
            }
            
            // Add difficulty-specific message
            switch (selectedDifficulty) {
                case 'easy':
                    feedbackMessage += " Try the medium difficulty next time!";
                    break;
                case 'medium':
                    feedbackMessage += " Challenge yourself with hard mode!";
                    break;
                case 'hard':
                    feedbackMessage += " Hard mode is a real challenge - great work!";
                    break;
            }
            
            document.getElementById("quizFeedback").innerText = feedbackMessage;
            
            // Update high score
            updateHighScore();
            
            // Save quiz result to leaderboard if the function exists
            if (typeof saveQuizResultToLeaderboard === 'function') {
                saveQuizResultToLeaderboard();
            }
        }
        
        // Function to save quiz results to leaderboard
        function saveQuizResultToLeaderboard() {
            // Only save results if user is logged in
            if (!currentUser) return;
            
            const percentage = Math.round((score / quizQuestions.length) * 100);
            const quizResult = {
                userId: currentUser.uid,
                displayName: getDisplayName(),
                score: score,
                totalQuestions: quizQuestions.length,
                percentage: percentage,
                difficulty: selectedDifficulty,
                timestamp: new Date().toISOString()
            };
            
            // Add to leaderboard in Firebase
            const leaderboardRef = ref(db, 'quiz_leaderboard');
            push(leaderboardRef, quizResult)
                .then(() => {
                    console.log("Score saved to leaderboard");
                })
                .catch(error => {
                    console.error("Error saving score:", error);
                });
        }
        
        // ==================== MULTIPLAYER FUNCTIONALITY ====================
        
        // Create multiplayer section
        function createMultiplayerSection() {
            // Only create if it doesn't exist
            if (document.getElementById('multiplayerSection')) return;
            
            const multiplayerSection = document.createElement('div');
            multiplayerSection.id = 'multiplayerSection';
            multiplayerSection.className = 'content-section';
            
            multiplayerSection.innerHTML = `
                <h3>Compete with Friends</h3>
                
                <div class="multiplayer-container">
                    <div id="connectionStatus" class="connection-status">Checking connection...</div>
                    
                    <div id="multiplayerMenu">
                        <p>Challenge a friend to a Kunama translation competition!</p>
                        
                        <div class="mp-actions">
                            <button id="createGameBtn" class="button mp-action-button">Create New Game</button>
                            <button id="joinGameBtn" class="button mp-action-button">Join Game</button>
                        </div>
                        
                        <div id="gameCodeSection" style="display: none;">
                            <p>Share this code with your friend:</p>
                            <div id="gameCode" class="mp-game-code">XXXX</div>
                            <button id="copyCodeBtn" class="button button-small" onclick="window.copyGameCode()">Copy Code</button>
                        </div>
                        
                        <div id="joinGameSection" style="display: none;">
                            <p>Enter the game code:</p>
                            <input type="text" id="joinCodeInput" class="input-field" style="max-width: 200px; text-align: center;" placeholder="Enter 4-digit code">
                            <button id="submitJoinBtn" class="button">Join</button>
                        </div>
                    </div>
                    
                    <div id="waitingRoom" style="display: none;">
                        <div id="waitingMessage" class="mp-status-message">Waiting for opponent to join...</div>
                        <div class="mp-waiting">
                            <div class="mp-waiting-animation"></div>
                        </div>
                        <button id="cancelWaitingBtn" class="button button-secondary">Cancel</button>
                    </div>
                    
                    <div id="gameInProgress" style="display: none;">
                        <div id="competitionStatus" class="mp-status-message">Game in progress</div>
                        
                        <div id="opponentStatus">Waiting for opponent...</div>
                        
                        <div id="mpQuestionContainer" style="display: none;">
                            <div id="mpTimerContainer">Time: <span id="mpTimer">15</span>s</div>
                            <div id="mpQuestionType">English to Kunama</div>
                            <div id="mpQuestionPrompt" style="font-size: 24px; font-weight: bold; margin: 20px 0;">Question</div>
                            
                            <div id="mpOptions" style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                                <!-- Options will be added dynamically -->
                            </div>
                            
                            <div id="mpQuestionFeedback" style="display: none; margin: 15px 0; padding: 10px; border-radius: 6px;"></div>
                        </div>
                        
                        <div id="scoreBoard" style="display: none; margin: 20px 0;">
                            <h4>Current Score</h4>
                            <div style="display: flex; justify-content: space-around; margin: 15px 0;">
                                <div id="yourScore" style="text-align: center;">
                                    <div class="score-label">You</div>
                                    <div class="score-value">0</div>
                                </div>
                                <div id="opponentScore" style="text-align: center;">
                                    <div class="score-label">Opponent</div>
                                    <div class="score-value">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="gameResults" style="display: none; margin: 20px 0;">
                            <h4>Game Results</h4>
                            <div id="resultMessage" style="font-size: 20px; margin: 15px 0; font-weight: bold;"></div>
                            <div id="finalScores" style="margin: 15px 0;"></div>
                            <button id="playAgainBtn" class="button">Play Again</button>
                            <button id="backToMenuBtn" class="button button-secondary">Back to Menu</button>
                        </div>
                    </div>
                    
                    <div id="activeGames" style="display: none; margin-top: 20px;">
                        <h4>Your Active Games</h4>
                        <div id="activeGamesList">
                            <!-- Active games will be listed here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Add to container
            document.querySelector('.container').appendChild(multiplayerSection);
            
            // Setup event listeners
            setupMultiplayerEvents();
        }
        
        // Setup multiplayer event listeners
        function setupMultiplayerEvents() {
            // Create game button
            document.getElementById('createGameBtn').addEventListener('click', () => {
                createCompetitionRoom();
            });
            
            // Join game button
            document.getElementById('joinGameBtn').addEventListener('click', () => {
                document.getElementById('joinGameSection').style.display = 'block';
                document.getElementById('gameCodeSection').style.display = 'none';
            });
            
            // Submit join button
            document.getElementById('submitJoinBtn').addEventListener('click', () => {
                const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
                if (code.length === 4) {
                    joinCompetitionRoom(code);
                } else {
                    showNotification('Please enter a valid 4-digit code', 'error');
                }
            });
            
            // Cancel waiting button
            document.getElementById('cancelWaitingBtn').addEventListener('click', () => {
                cancelWaiting();
            });
            
            // Play again button
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                resetMultiplayerGame();
                createCompetitionRoom();
            });
            
            // Back to menu button
            document.getElementById('backToMenuBtn').addEventListener('click', () => {
                resetMultiplayerGame();
                showMultiplayerMenu();
            });
        }
        
        // Function to check connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            
            // Check connection to Firebase
            const connectedRef = ref(db, '.info/connected');
            get(connectedRef).then((snapshot) => {
                if (snapshot.val() === true) {
                    statusElement.textContent = 'Connected';
                    statusElement.className = 'connection-status online';
                } else {
                    statusElement.textContent = 'Offline';
                    statusElement.className = 'connection-status offline';
                }
            }).catch((error) => {
                console.error('Error checking connection:', error);
                statusElement.textContent = 'Connection Error';
                statusElement.className = 'connection-status offline';
            });
        }
        
        // Function to create a competition room
        function createCompetitionRoom() {
            // Ensure user is authenticated
            if (!currentUser) {
                showNotification('Please sign in to create a game', 'error');
                return;
            }
            
            // Generate a random 4-letter room code
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Avoiding easily confused characters
            let roomCode = '';
            for (let i = 0; i < 4; i++) {
                roomCode += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            
            // Create room in Firebase
            const roomRef = ref(db, `multiplayer_games/${roomCode}`);
            set(roomRef, {
                host: {
                    id: currentUser.uid,
                    name: getDisplayName(),
                    ready: false,
                    score: 0
                },
                guest: null,
                status: 'waiting',
                createdAt: new Date().toISOString(),
                questions: null,
                currentQuestion: 0
            }).then(() => {
                // Show room code
                document.getElementById('gameCode').textContent = roomCode;
                document.getElementById('gameCodeSection').style.display = 'block';
                document.getElementById('joinGameSection').style.display = 'none';
                
                // Hide menu and show waiting room
                document.getElementById('multiplayerMenu').style.display = 'none';
                document.getElementById('waitingRoom').style.display = 'block';
                
                // Set current room and player role
                competitionRoomId = roomCode;
                playerRole = 'host';
                
                // Start listening for opponent
                listenForOpponent(roomCode);
                
            }).catch((error) => {
                console.error('Error creating room:', error);
                showNotification('Error creating game room', 'error');
            });
        }
        
        // Function to join a competition room
        function joinCompetitionRoom(roomCode) {
            // Ensure user is authenticated
            if (!currentUser) {
                showNotification('Please sign in to join a game', 'error');
                return;
            }
            
            // Check if room exists
            const roomRef = ref(db, `multiplayer_games/${roomCode}`);
            get(roomRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    
                    // Check if room is waiting for players
                    if (roomData.status === 'waiting') {
                        // Check if user is trying to join their own game
                        if (roomData.host && roomData.host.id === currentUser.uid) {
                            showNotification('You cannot join your own game', 'error');
                            return;
                        }
                        
                        // Join as guest
                        const updates = {};
                        updates['guest'] = {
                            id: currentUser.uid,
                            name: getDisplayName(),
                            ready: true,
                            score: 0
                        };
                        updates['status'] = 'ready';
                        
                        // Update room
                        update(ref(db, `multiplayer_games/${roomCode}`), updates)
                            .then(() => {
                                // Set current room and player role
                                competitionRoomId = roomCode;
                                playerRole = 'guest';
                                
                                // Hide menu and show game in progress
                                document.getElementById('multiplayerMenu').style.display = 'none';
                                document.getElementById('gameInProgress').style.display = 'block';
                                
                                // Update opponent info
                                document.getElementById('opponentStatus').textContent = `Playing against: ${roomData.host.name}`;
                                
                                // Listen for game progress
                                listenForGameProgress(roomCode);
                                
                            }).catch((error) => {
                                console.error('Error joining room:', error);
                                showNotification('Error joining game', 'error');
                            });
                        
                    } else {
                        showNotification('This game is no longer accepting players', 'error');
                    }
                } else {
                    showNotification('Game not found with that code', 'error');
                }
            }).catch((error) => {
                console.error('Error checking room:', error);
                showNotification('Error checking game room', 'error');
            });
        }
        
        // Function to listen for opponent joining
        function listenForOpponent(roomCode) {
            const roomRef = ref(db, `multiplayer_games/${roomCode}`);
            
            // Listen for changes to the room
            const unsubscribe = onValue(roomRef, (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    
                    if (roomData.status === 'ready' && roomData.guest) {
                        // Opponent has joined
                        document.getElementById('waitingRoom').style.display = 'none';
                        document.getElementById('gameInProgress').style.display = 'block';
                        
                        // Update opponent info
                        document.getElementById('opponentStatus').textContent = `Playing against: ${roomData.guest.name}`;
                        
                        // Prepare competition questions
                        prepareCompetitionQuestions(roomCode);
                        
                        // Listen for game progress
                        listenForGameProgress(roomCode);
                        
                        // Stop listening for opponent
                        unsubscribe();
                    }
                } else {
                    // Room was deleted
                    showNotification('Game room was closed', 'info');
                    resetMultiplayerGame();
                    showMultiplayerMenu();
                    
                    // Stop listening
                    unsubscribe();
                }
            });
        }
        
        // Function to prepare competition questions
        function prepareCompetitionQuestions(roomCode) {
            // Only host creates questions
            if (playerRole !== 'host') return;
            
            // Get approved phrases from Firebase
            const approvedPhrasesRef = ref(db, 'approved_phrases');
            get(approvedPhrasesRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const allPhrases = [];
                    snapshot.forEach((childSnapshot) => {
                        const phraseData = childSnapshot.val();
                        if (phraseData.phrase && phraseData.translation) {
                            allPhrases.push(phraseData);
                        }
                    });
                    
                    // Need at least 5 phrases
                    if (allPhrases.length >= 5) {
                        // Shuffle array
                        for (let i = allPhrases.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [allPhrases[i], allPhrases[j]] = [allPhrases[j], allPhrases[i]];
                        }
                        
                        // Take first 5 phrases
                        const competitionQuestions = [];
                        
                        for (let i = 0; i < 5; i++) {
                            const phrase = allPhrases[i];
                            const isEnglishToKunama = i % 2 === 0; // Alternate question types
                            
                            // Create correct answer
                            const correctAnswer = isEnglishToKunama ? phrase.translation : phrase.phrase;
                            
                            // Create options array (starting with correct answer)
                            let options = [correctAnswer];
                            
                            // Add 3 random incorrect options
                            let attemptCount = 0;
                            while (options.length < 4 && attemptCount < 20) {
                                attemptCount++;
                                const randomIndex = Math.floor(Math.random() * allPhrases.length);
                                const randomOption = isEnglishToKunama ? 
                                    allPhrases[randomIndex].translation : 
                                    allPhrases[randomIndex].phrase;
                                
                                // Make sure we don't add duplicates
                                if (!options.includes(randomOption) && randomOption !== correctAnswer) {
                                    options.push(randomOption);
                                }
                            }
                            
                            // Fill with dummy options if needed
                            while (options.length < 4) {
                                options.push(`Option ${options.length + 1}`);
                            }
                            
                            // Shuffle options
                            for (let j = options.length - 1; j > 0; j--) {
                                const k = Math.floor(Math.random() * (j + 1));
                                [options[j], options[k]] = [options[k], options[j]];
                            }
                            
                            // Create question object
                            competitionQuestions.push({
                                prompt: isEnglishToKunama ? phrase.phrase : phrase.translation,
                                options: options,
                                correctAnswer: correctAnswer,
                                isEnglishToKunama: isEnglishToKunama
                            });
                        }
                        
                        // Save questions to Firebase
                        update(ref(db, `multiplayer_games/${roomCode}`), {
                            questions: competitionQuestions,
                            status: 'playing',
                            currentQuestion: 0
                        }).catch((error) => {
                            console.error('Error saving questions:', error);
                            showNotification('Error preparing game questions', 'error');
                        });
                    } else {
                        // Not enough phrases
                        showNotification('Not enough phrases to create a game', 'error');
                        resetMultiplayerGame();
                        showMultiplayerMenu();
                    }
                } else {
                    // No phrases found
                    showNotification('No phrases found to create a game', 'error');
                    resetMultiplayerGame();
                    showMultiplayerMenu();
                }
            }).catch((error) => {
                console.error('Error fetching phrases:', error);
                showNotification('Error preparing game', 'error');
            });
        }
        
        // Function to listen for game progress
        function listenForGameProgress(roomCode) {
            const roomRef = ref(db, `multiplayer_games/${roomCode}`);
            
            // Listen for changes to the room
            onValue(roomRef, (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    
                    // Handle different game states
                    switch (roomData.status) {
                        case 'playing':
                            // Game is in progress
                            if (roomData.questions && roomData.currentQuestion < roomData.questions.length) {
                                // Show current question
                                showCompetitionQuestion(roomData.currentQuestion, roomData.questions);
                            }
                            break;
                            
                        case 'completed':
                            // Game is finished
                            showGameResults(roomData);
                            break;
                            
                        case 'abandoned':
                            // Opponent left
                            showNotification('Opponent has left the game', 'info');
                            resetMultiplayerGame();
                            showMultiplayerMenu();
                            break;
                    }
                    
                    // Update scoreboard
                    updateScoreboard(roomData);
                    
                } else {
                    // Room was deleted
                    showNotification('Game room was closed', 'info');
                    resetMultiplayerGame();
                    showMultiplayerMenu();
                }
            });
        }
        
        // Function to show competition question
        function showCompetitionQuestion(questionIndex, questions = null) {
            // If questions are provided, use them
            if (questions) {
                competitionQuestions = questions;
            }
            
            // Get current question
            const question = competitionQuestions[questionIndex];
            
            // Show question container
            document.getElementById('mpQuestionContainer').style.display = 'block';
            
            // Update question content
            document.getElementById('mpQuestionType').textContent = question.isEnglishToKunama ? 
                'English to Kunama' : 'Kunama to English';
            document.getElementById('mpQuestionPrompt').textContent = question.prompt;
            
            // Clear previous options
            const optionsContainer = document.getElementById('mpOptions');
            optionsContainer.innerHTML = '';
            
            // Add new options
            question.options.forEach((option, index) => {
                const optionButton = document.createElement('button');
                optionButton.className = 'quiz-option mp-option';
                optionButton.textContent = option;
                optionButton.onclick = () => handleCompetitionAnswer(index);
                optionsContainer.appendChild(optionButton);
            });
            
            // Hide feedback
            document.getElementById('mpQuestionFeedback').style.display = 'none';
            
            // Start timer (15 seconds per question)
            startCompetitionTimer();
        }
        
        // Function to start competition timer
        function startCompetitionTimer() {
            // Clear any existing timer
            if (competitionTimer) {
                clearInterval(competitionTimer);
            }
            
            // Set timer to 15 seconds
            let timeLeft = 15;
            document.getElementById('mpTimer').textContent = timeLeft;
            
            // Start countdown
            competitionTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('mpTimer').textContent = timeLeft;
                
                // Add warning class when time is running out
                if (timeLeft <= 5) {
                    document.getElementById('mpTimer').classList.add('timer-warning');
                }
                
                // Time's up
                if (timeLeft <= 0) {
                    clearInterval(competitionTimer);
                    handleTimedOut();
                }
            }, 1000);
        }
        
        // Function to handle timed out
        function handleTimedOut() {
            // Get current question index
            const gameRef = ref(db, `multiplayer_games/${competitionRoomId}`);
            
            get(gameRef).then(snapshot => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    const currentQuestionIndex = gameData.currentQuestion;
                    
                    // Record timeout
                    const playerPath = playerRole === 'host' ? 'host' : 'guest';
                    const updates = {};
                    updates[`${playerPath}/lastAnswer`] = {
                        questionIndex: currentQuestionIndex,
                        timedOut: true,
                        isCorrect: false,
                        timestamp: new Date().toISOString()
                    };
                    
                    update(gameRef, updates).then(() => {
                        // Show feedback
                        const feedbackElement = document.getElementById('mpQuestionFeedback');
                        feedbackElement.textContent = "⏱️ Time's up!";
                        feedbackElement.className = 'incorrect';
                        feedbackElement.style.display = 'block';
                        
                        // Disable all options
                        const options = document.querySelectorAll('.mp-option');
                        options.forEach(option => {
                            option.style.pointerEvents = 'none';
                        });
                        
                        // Move to next question after delay
                        setTimeout(() => {
                            const nextQuestionIndex = currentQuestionIndex + 1;
                            
                            if (nextQuestionIndex < competitionQuestions.length) {
                                showCompetitionQuestion(nextQuestionIndex);
                            } else {
                                endCompetition();
                            }
                        }, 2000);
                    });
                }
            });
        }
        
        // Function to handle competition answer
        function handleCompetitionAnswer(optionIndex) {
            // Clear timer
            clearInterval(competitionTimer);
            
            // Get current question data
            const gameRef = ref(db, `multiplayer_games/${competitionRoomId}`);
            
            get(gameRef).then(snapshot => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    const currentQuestionIndex = gameData.currentQuestion;
                    const question = competitionQuestions[currentQuestionIndex];
                    const selectedOption = question.options[optionIndex];
                    const isCorrect = selectedOption === question.correctAnswer;
                    
                    // Record answer
                    const playerPath = playerRole === 'host' ? 'host' : 'guest';
                    const updates = {};
                    
                    // Update last answer
                    updates[`${playerPath}/lastAnswer`] = {
                        questionIndex: currentQuestionIndex,
                        selectedOption: selectedOption,
                        isCorrect: isCorrect,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Update score if correct
                    if (isCorrect) {
                        updates[`${playerPath}/score`] = gameData[playerPath].score + 1;
                    }
                    
                    // Submit updates
                    update(gameRef, updates).then(() => {
                        // Show feedback
                        const feedbackElement = document.getElementById('mpQuestionFeedback');
                        
                        if (isCorrect) {
                            feedbackElement.textContent = "✅ Correct!";
                            feedbackElement.className = 'correct';
                        } else {
                            feedbackElement.textContent = `❌ Incorrect. The correct answer is: ${question.correctAnswer}`;
                            feedbackElement.className = 'incorrect';
                        }
                        
                        feedbackElement.style.display = 'block';
                        
                        // Highlight correct/incorrect options
                        const options = document.querySelectorAll('.mp-option');
                        options.forEach((option, idx) => {
                            // Disable all options
                            option.style.pointerEvents = 'none';
                            
                            // Highlight correct answer
                            if (option.textContent === question.correctAnswer) {
                                option.classList.add('correct-answer');
                            }
                            
                            // Highlight selected wrong answer
                            if (idx === optionIndex && !isCorrect) {
                                option.classList.add('wrong-answer');
                            }
                        });
                        
                        // Move to next question or end game
                        setTimeout(() => {
                            // Check if both players have answered
                            get(gameRef).then(snapshot => {
                                if (snapshot.exists()) {
                                    const updatedData = snapshot.val();
                                    const hostAnswered = updatedData.host && updatedData.host.lastAnswer && 
                                        updatedData.host.lastAnswer.questionIndex === currentQuestionIndex;
                                    const guestAnswered = updatedData.guest && updatedData.guest.lastAnswer && 
                                        updatedData.guest.lastAnswer.questionIndex === currentQuestionIndex;
                                    
                                    // If both answered or you're the host, advance to next question
                                    if ((hostAnswered && guestAnswered) || playerRole === 'host') {
                                        const nextQuestionIndex = currentQuestionIndex + 1;
                                        
                                        if (nextQuestionIndex < competitionQuestions.length) {
                                            // Move to next question
                                            if (playerRole === 'host') {
                                                // Only host updates the current question
                                                update(gameRef, { currentQuestion: nextQuestionIndex });
                                            }
                                        } else {
                                            // End competition
                                            if (playerRole === 'host') {
                                                endCompetition();
                                            }
                                        }
                                    }
                                }
                            });
                        }, 2000);
                    });
                }
            });
        }
        
        // Function to end competition
        function endCompetition() {
            if (!competitionRoomId || playerRole !== 'host') return;
            
            const gameRef = ref(db, `multiplayer_games/${competitionRoomId}`);
            
            // Update game status to completed
            update(gameRef, { status: 'completed' });
        }
        
        // Function to update scoreboard
        function updateScoreboard(gameData) {
            if (!gameData.host || !gameData.guest) return;
            
            // Show scoreboard
            document.getElementById('scoreBoard').style.display = 'block';
            
            // Update scores
            const yourScore = playerRole === 'host' ? gameData.host.score : gameData.guest.score;
            const opponentScore = playerRole === 'host' ? gameData.guest.score : gameData.host.score;
            
            document.querySelector('#yourScore .score-value').textContent = yourScore;
            document.querySelector('#opponentScore .score-value').textContent = opponentScore;
        }
        
        // Function to show game results
        function showGameResults(gameData) {
            // Hide question container
            document.getElementById('mpQuestionContainer').style.display = 'none';
            
            // Show results container
            document.getElementById('gameResults').style.display = 'block';
            
            // Update final scores
            const yourScore = playerRole === 'host' ? gameData.host.score : gameData.guest.score;
            const opponentScore = playerRole === 'host' ? gameData.guest.score : gameData.host.score;
            const opponentName = playerRole === 'host' ? gameData.guest.name : gameData.host.name;
            
            // Show result message
            const resultMessage = document.getElementById('resultMessage');
            
            if (yourScore > opponentScore) {
                resultMessage.textContent = '🏆 You won!';
                resultMessage.style.color = '#4CAF50';
            } else if (yourScore < opponentScore) {
                resultMessage.textContent = '😢 You lost';
                resultMessage.style.color = '#F44336';
            } else {
                resultMessage.textContent = '🤝 It\'s a tie!';
                resultMessage.style.color = '#2196F3';
            }
            
            // Show final scores
            document.getElementById('finalScores').innerHTML = `
                <p>Your score: ${yourScore} points</p>
                <p>${opponentName}'s score: ${opponentScore} points</p>
            `;
        }
        
        // Function to cancel waiting
        function cancelWaiting() {
            if (!competitionRoomId) return;
            
            // Remove the game room
            const roomRef = ref(db, `multiplayer_games/${competitionRoomId}`);
            remove(roomRef).then(() => {
                resetMultiplayerGame();
                showMultiplayerMenu();
                showNotification('Game cancelled', 'info');
            }).catch((error) => {
                console.error('Error cancelling game:', error);
                showNotification('Error cancelling game', 'error');
            });
        }
        
        // Function to abandon a game
        function abandonGame(gameId) {
            const gameRef = ref(db, `multiplayer_games/${gameId}`);
            
            // Update game status to abandoned
            update(gameRef, { status: 'abandoned' })
                .then(() => {
                    showNotification('Game abandoned', 'info');
                    checkActiveGames();
                })
                .catch((error) => {
                    console.error('Error abandoning game:', error);
                    showNotification('Error abandoning game', 'error');
                });
        }
        
        // Function to copy game code
        function copyGameCode() {
            const gameCode = document.getElementById('gameCode').textContent;
            navigator.clipboard.writeText(gameCode)
                .then(() => {
                    showNotification('Game code copied to clipboard');
                })
                .catch((error) => {
                    console.error('Error copying code:', error);
                    showNotification('Error copying code', 'error');
                });
        }
        
        // Function to reset multiplayer game state
        function resetMultiplayerGame() {
            // Clear timers
            if (competitionTimer) {
                clearInterval(competitionTimer);
                competitionTimer = null;
            }
            
            // Reset variables
            competitionRoomId = null;
            playerRole = null;
            competitionQuestions = [];
            
            // Reset UI
            document.getElementById('multiplayerMenu').style.display = 'block';
            document.getElementById('waitingRoom').style.display = 'none';
            document.getElementById('gameInProgress').style.display = 'none';
            document.getElementById('gameCodeSection').style.display = 'none';
            document.getElementById('joinGameSection').style.display = 'none';
            document.getElementById('mpQuestionContainer').style.display = 'none';
            document.getElementById('scoreBoard').style.display = 'none';
            document.getElementById('gameResults').style.display = 'none';
        }
        
        // Function to show multiplayer menu
        function showMultiplayerMenu() {
            resetMultiplayerGame();
            
            // Check for active games
            checkActiveGames();
        }
        
        // Function to check for active games
        function checkActiveGames() {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const gamesRef = ref(db, 'multiplayer_games');
            
            // Query games where this user is host or guest
            get(gamesRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const activeGames = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const gameId = childSnapshot.key;
                        const gameData = childSnapshot.val();
                        
                        // Check if user is in this game
                        const isHost = gameData.host && gameData.host.id === userId;
                        const isGuest = gameData.guest && gameData.guest.id === userId;
                        
                        if ((isHost || isGuest) && gameData.status !== 'abandoned') {
                            activeGames.push({
                                id: gameId,
                                role: isHost ? 'host' : 'guest',
                                opponent: isHost ? 
                                    (gameData.guest ? gameData.guest.name : 'Waiting for opponent') : 
                                    gameData.host.name,
                                status: gameData.status,
                                createdAt: gameData.createdAt
                            });
                        }
                    });
                    
                    // Show active games if there are any
                    if (activeGames.length > 0) {
                        showActiveGames(activeGames);
                    } else {
                        document.getElementById('activeGames').style.display = 'none';
                    }
                }
            });
        }
        
        // Function to show active games
        function showActiveGames(games) {
            const listContainer = document.getElementById('activeGamesList');
            listContainer.innerHTML = '';
            
            games.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'result-item';
                gameItem.style.marginBottom = '10px';
                
                // Format created date
                const createdDate = new Date(game.createdAt);
                const formattedDate = createdDate.toLocaleDateString() + ' ' + createdDate.toLocaleTimeString();
                
                // Create game item content
                gameItem.innerHTML = `
                    <div>
                        <strong>Game Code:</strong> ${game.id}<br>
                        <strong>Opponent:</strong> ${game.opponent}<br>
                        <strong>Status:</strong> ${game.status}<br>
                        <strong>Created:</strong> ${formattedDate}
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                        ${game.status !== 'completed' ? `
                            <button class="button button-small" onclick="window.resumeGame('${game.id}', '${game.role}')">Resume</button>
                            <button class="button button-small button-secondary" style="margin-left: 10px;" onclick="window.abandonGame('${game.id}')">Abandon</button>
                        ` : `
                            <button class="button button-small button-secondary" onclick="window.abandonGame('${game.id}')">Clear</button>
                        `}
                    </div>
                `;
                
                listContainer.appendChild(gameItem);
            });
            
            // Show active games section
            document.getElementById('activeGames').style.display = 'block';
        }
        
        // Function to resume a game
        function resumeGame(gameId, role) {
            // Set current room and player role
            competitionRoomId = gameId;
            playerRole = role;
            
            // Show game UI
            document.getElementById('multiplayerMenu').style.display = 'none';
            document.getElementById('gameInProgress').style.display = 'block';
            
            // Listen for game progress
            listenForGameProgress(gameId);
            
            // Get current game state
            const gameRef = ref(db, `multiplayer_games/${gameId}`);
            get(gameRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    
                    // Update opponent info
                    const opponentName = playerRole === 'host' ? 
                        (gameData.guest ? gameData.guest.name : 'Waiting for opponent') : 
                        gameData.host.name;
                    
                    document.getElementById('opponentStatus').textContent = `Playing against: ${opponentName}`;
                    
                    // If game is waiting, show waiting screen
                    if (gameData.status === 'waiting') {
                        document.getElementById('gameInProgress').style.display = 'none';
                        document.getElementById('waitingRoom').style.display = 'block';
                        document.getElementById('gameCode').textContent = gameId;
                        document.getElementById('gameCodeSection').style.display = 'block';
                    }
                }
            });
        }
        
        // Add multiplayer styles
        function addMultiplayerStyles() {
            // Check if styles already exist
            if (document.getElementById('multiplayerStyles')) return;
            
            // Create style element
            const styleElement = document.createElement('style');
            styleElement.id = 'multiplayerStyles';
            
            // Add styles
            styleElement.textContent = `
                #mpQuestionFeedback.correct {
                    background-color: #E8F5E9;
                    color: #2E7D32;
                }
                
                #mpQuestionFeedback.incorrect {
                    background-color: #FFEBEE;
                    color: #C62828;
                }
                
                .score-label {
                    font-size: 16px;
                    margin-bottom: 5px;
                    color: #666;
                }
                
                .score-value {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2a5298;
                }
                
                body.dark-mode .score-label {
                    color: #aaa;
                }
                
                body.dark-mode .score-value {
                    color: #81a4ff;
                }
            `;
            
            // Add to document
            document.head.appendChild(styleElement);
        }
        
        // Add multiplayer achievements
        function addMultiplayerAchievements() {
            // This function would add multiplayer-specific achievements to the user's profile
            // For now, just a placeholder
        }
        
        // ==================== AUTHENTICATION FUNCTIONALITY ====================
        
        // Authentication user management
        function setupAuthentication() {
            // Auth state changes
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    isAnonymous = user.isAnonymous;
                    console.log("User is signed in with ID:", user.uid);
                    
                    // Store the user ID as contributor ID
                    localStorage.setItem("kunama_contributor_id", user.uid);
                    
                    // Update UI for authenticated user
                    updateAuthUI();
                } else {
                    // User is signed out
                    console.log("User is signed out");
                    currentUser = null;
                    isAnonymous = true;
                    
                    // Update UI for signed out user
                    updateAuthUI();
                }
            });
            
            // Add click event to user menu button
            document.getElementById('userMenuBtn').addEventListener('click', () => {
                if (currentUser) {
                    // Show profile section
                    toggleProfileSection();
                } else {
                    // Show auth modal
                    showAuthModal();
                }
            });
            
            // Setup auth modal
            setupAuthModal();
            
            // Setup profile section
            setupProfileSection();
        }
        
        // Update UI based on authentication state
        function updateAuthUI() {
            const userNameElement = document.getElementById('userName');
            const userIconElement = document.getElementById('userIcon');
            
            if (currentUser) {
                // Get display name from different sources in order of preference
                let displayName = getDisplayName();
                
                // Update user menu
                userNameElement.textContent = displayName;
                userIconElement.textContent = '👤';
                
                // Update profile section
                document.getElementById('profileName').textContent = displayName;
                document.getElementById('profileEmail').textContent = currentUser.email || 'Anonymous User';
                document.getElementById('profileAvatar').textContent = getInitials(displayName);
                document.getElementById('displayNameInput').value = displayName;
            } else {
                // Update for non-authenticated user
                userNameElement.textContent = 'Sign in';
                userIconElement.textContent = '👤';
                
                // Hide profile section if it's open
                document.getElementById('userProfileSection').style.display = 'none';
            }
        }
        
        // Toggle profile section visibility
        function toggleProfileSection() {
            const profileSection = document.getElementById('userProfileSection');
            
            if (profileSection.style.display === 'none' || !profileSection.style.display) {
                profileSection.style.display = 'block';
            } else {
                profileSection.style.display = 'none';
            }
        }
        
        // Get display name from various sources
        function getDisplayName() {
            // Order of preference: 
            // 1. Custom display name in localStorage
            // 2. Firebase auth display name
            // 3. Email username
            // 4. "Anonymous User"
            const storedName = localStorage.getItem('kunama_display_name');
            
            if (storedName) {
                return storedName;
            } else if (currentUser && currentUser.displayName) {
                return currentUser.displayName;
            } else if (currentUser && currentUser.email) {
                return currentUser.email.split('@')[0];
            } else {
                return 'Anonymous User';
            }
        }
        
        // Get initials from name for avatar
        function getInitials(name) {
            if (!name || name === 'Anonymous User') return '?';
            
            const parts = name.split(' ');
            if (parts.length === 1) {
                return name.charAt(0).toUpperCase();
            } else {
                return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
            }
        }
        
        // Setup auth modal
        function setupAuthModal() {
            // Tab switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Form').classList.add('active');
                });
            });
            
            // Switch between forms
            document.getElementById('switchToSignup').addEventListener('click', () => {
                document.querySelector('.auth-tab[data-tab="signup"]').click();
            });
            
            document.getElementById('switchToSignin').addEventListener('click', () => {
                document.querySelector('.auth-tab[data-tab="signin"]').click();
            });
            
            // Continue anonymously
            document.getElementById('continueAnonymously').addEventListener('click', () => {
                signInAnonymously(auth)
                    .then(() => {
                        hideAuthModal();
                        showNotification('Continuing anonymously');
                    })
                    .catch(error => {
                        console.error('Error signing in anonymously:', error);
                        showNotification('Failed to sign in anonymously', 'error');
                    });
            });
            
            document.getElementById('continueAnonymously2').addEventListener('click', () => {
                signInAnonymously(auth)
                    .then(() => {
                        hideAuthModal();
                        showNotification('Continuing anonymously');
                    })
                    .catch(error => {
                        console.error('Error signing in anonymously:', error);
                        showNotification('Failed to sign in anonymously', 'error');
                    });
            });
            
            // Sign in
            document.getElementById('signinBtn').addEventListener('click', () => {
                const email = document.getElementById('signinEmail').value;
                const password = document.getElementById('signinPassword').value;
                
                if (!email || !password) {
                    showNotification('Please enter both email and password', 'error');
                    return;
                }
                
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => {
                        hideAuthModal();
                        showNotification('Signed in successfully');
                    })
                    .catch(error => {
                        console.error('Error signing in:', error);
                        showNotification('Failed to sign in: ' + error.message, 'error');
                    });
            });
            
            // Sign up
            document.getElementById('signupBtn').addEventListener('click', () => {
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                
                if (!name || !email || !password) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }
                
                createUserWithEmailAndPassword(auth, email, password)
                    .then(userCredential => {
                        // Set display name
                        updateProfile(userCredential.user, {
                            displayName: name
                        }).then(() => {
                            // Also save to localStorage
                            localStorage.setItem('kunama_display_name', name);
                            
                            hideAuthModal();
                            showNotification('Account created successfully');
                        });
                    })
                    .catch(error => {
                        console.error('Error signing up:', error);
                        showNotification('Failed to create account: ' + error.message, 'error');
                    });
            });
        }
        
        // Setup profile section
        function setupProfileSection() {
            // Save profile button
            document.getElementById('saveProfileBtn').addEventListener('click', () => {
                const displayName = document.getElementById('displayNameInput').value;
                
                if (!displayName) {
                    showNotification('Please enter a display name', 'error');
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('kunama_display_name', displayName);
                
                // If user is authenticated (not anonymous), update profile in Firebase
                if (currentUser && !isAnonymous) {
                    updateProfile(currentUser, {
                        displayName: displayName
                    }).then(() => {
                        updateAuthUI();
                        showNotification('Profile saved successfully');
                    }).catch(error => {
                        console.error('Error updating profile:', error);
                        // Still update local UI since we saved to localStorage
                        updateAuthUI();
                        showNotification('Profile saved locally');
                    });
                } else {
                    // Just update the UI for anonymous users
                    updateAuthUI();
                    showNotification('Profile saved locally');
                }
            });
            
            // Sign out button
            document.getElementById('signOutBtn').addEventListener('click', () => {
                signOut(auth).then(() => {
                    showNotification('Signed out successfully');
                    
                    // Create a placeholder anonymous user for app functionality
                    const contributorId = "anonymous_" + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("kunama_contributor_id", contributorId);
                    updateAuthUI();
                }).catch(error => {
                    console.error('Error signing out:', error);
                    showNotification('Failed to sign out', 'error');
                });
            });
        }
        
        // Show auth modal
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }
        
        // Hide auth modal
        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            
            // Clear inputs
            document.getElementById('signinEmail').value = '';
            document.getElementById('signinPassword').value = '';
            document.getElementById('signupName').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        // Escape HTML to prevent XSS
        function escapeHTML(str) {
            if (!str) return '';
            return str
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Format relative time
        function formatRelativeTime(timestamp) {
            if (!timestamp) return "Recently";
            
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            
            if (diffSeconds < 60) return "Just now";
            if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)} minutes ago`;
            if (diffSeconds < 86400) return `${Math.floor(diffSeconds / 3600)} hours ago`;
            if (diffSeconds < 604800) return `${Math.floor(diffSeconds / 86400)} days ago`;
            
            return date.toLocaleDateString();
        }

        // Show notification
        function showNotification(message, type = "success") {
            const notification = document.createElement("div");
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => {
                notification.style.opacity = "1";
                notification.style.transform = "translateY(0)";
            }, 10);
            
            // Fade out and remove
            setTimeout(() => {
                notification.style.opacity = "0";
                notification.style.transform = "translateY(-20px)";
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification("Copied to clipboard!");
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showNotification("Copy failed", "error");
            });
        }

        // ==================== PROGRESS BAR FUNCTIONALITY ====================
        
        // Update progress bar
        function updateProgressBar() {
            const goal = 5000; // Total goal of submissions
            const submissionCountRef = ref(db, 'submission_count');  // Reference to 'submission_count'

            // Get the current submission count
            get(submissionCountRef).then((snapshot) => {
                const numSubmissions = snapshot.exists() ? snapshot.val() : 0;  // Get the current submission count
                const percentage = Math.min((numSubmissions / goal) * 100, 100);  // Ensure percentage does not exceed 100%

                // Update the progress bar
                document.getElementById("progressBar").style.width = percentage + "%";
                document.getElementById("progressText").innerText = `${numSubmissions} / ${goal} submissions (${Math.round(percentage)}%)`;
            }).catch((error) => {
                console.error("Error fetching submission count:", error);
            });
        }

        // ==================== CHARACTER COUNTER FUNCTIONALITY ====================
        
        // Setup character counters
        function setupCharacterCounters() {
            const inputFields = [
                { input: document.getElementById("newPhrase"), counter: "phraseCounter", limit: 200 },
                { input: document.getElementById("newTranslation"), counter: "translationCounter", limit: 200 }
            ];
            
            // Create counter elements if they don't exist
            inputFields.forEach(field => {
                const counterEl = document.createElement("span");
                counterEl.id = field.counter;
                counterEl.className = "char-counter";
                field.input.parentNode.insertBefore(counterEl, field.input.nextSibling);
                
                // Initial count
                updateCounter(field.input, counterEl, field.limit);
                
                // Add event listener for input changes
                field.input.addEventListener("input", () => {
                    updateCounter(field.input, counterEl, field.limit);
                });
            });
        }

        // Update counter display
        function updateCounter(inputElement, counterElement, limit) {
            const currentLength = inputElement.value.length;
            counterElement.textContent = `${currentLength}/${limit}`;
            
            // Visual feedback for approaching limit
            if (currentLength > limit * 0.8) {
                counterElement.style.color = "#ff9800";
            } else {
                counterElement.style.color = "#777";
            }
            
            // Visual feedback for exceeding limit
            if (currentLength > limit) {
                counterElement.style.color = "#f44336";
            }
        }

        // ==================== AUTO-SAVE FUNCTIONALITY ====================
        
        // Setup auto-save
        function setupAutoSave() {
            const inputFields = [
                { id: "newPhrase", storageKey: "kunama_autosave_phrase" },
                { id: "newTranslation", storageKey: "kunama_autosave_translation" },
                { id: "newCategory", storageKey: "kunama_autosave_category" }
            ];
            
            // Load saved data on page load
            inputFields.forEach(field => {
                const savedValue = localStorage.getItem(field.storageKey);
                if (savedValue) {
                    document.getElementById(field.id).value = savedValue;
                }
                
                // Set up auto-save on input
                document.getElementById(field.id).addEventListener("input", (e) => {
                    localStorage.setItem(field.storageKey, e.target.value);
                    showAutoSaveIndicator();
                });
            });
        }

        // Show auto-save indicator
        function showAutoSaveIndicator() {
            // Create or update autosave indicator
            let indicator = document.getElementById("autosaveIndicator");
            if (!indicator) {
                indicator = document.createElement("span");
                indicator.id = "autosaveIndicator";
                indicator.className = "autosave-indicator";
                document.getElementById("addSection").appendChild(indicator);
            }
            
            // Show saving message
            indicator.innerHTML = "Auto-saving...";
            indicator.style.opacity = "1";
            
            // Hide message after delay
            setTimeout(() => {
                indicator.innerHTML = "Saved";
                setTimeout(() => {
                    indicator.style.opacity = "0";
                }, 800);
            }, 700);
        }

        // Clear saved data after successful submission
        function clearAutoSavedData() {
            localStorage.removeItem("kunama_autosave_phrase");
            localStorage.removeItem("kunama_autosave_translation");
            localStorage.removeItem("kunama_autosave_category");
        }

        // ==================== SUBMISSION FUNCTIONALITY ====================
        
        // Confirm submission dialog
        function confirmSubmission(phrase, translation, category, onConfirm) {
            // Create modal elements
            const modalOverlay = document.createElement("div");
            modalOverlay.className = "modal-overlay";
            
            const modalContent = document.createElement("div");
            modalContent.className = "modal-content";
            
            // Add content to modal
            modalContent.innerHTML = `
                <h3>Confirm Submission</h3>
                <p>Are you sure you want to submit the following translation?</p>
                <div class="confirm-details">
                    <p><strong>English:</strong> ${escapeHTML(phrase)}</p>
                    <p><strong>Kunama:</strong> ${escapeHTML(translation)}</p>
                    ${category ? `<p><strong>Category:</strong> ${escapeHTML(category)}</p>` : ''}
                </div>
                <div class="confirm-buttons">
                    <button id="confirmCancel" class="button button-secondary">Cancel</button>
                    <button id="confirmSubmit" class="button">Submit</button>
                </div>
            `;
            
            // Add modal to page
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            
            // Handle buttons
            document.getElementById("confirmCancel").addEventListener("click", () => {
                document.body.removeChild(modalOverlay);
            });
            
            document.getElementById("confirmSubmit").addEventListener("click", () => {
                document.body.removeChild(modalOverlay);
                onConfirm();
            });
        }

        // Add new phrase to Firebase
        function addNewPhraseToFirebase(phrase, translation, category = "") {
            // Get contributor ID from Firebase Auth or generate a temporary one
            const contributorId = currentUser ? currentUser.uid : "anonymous_" + Math.random().toString(36).substr(2, 9);
            
            // Get contributor name from various sources
            const contributorName = getDisplayName();
            
            // Save contribution information
            const newSubmissionsRef = ref(db, 'pending_submissions');
            const newPhraseRef = push(newSubmissionsRef);
            set(newPhraseRef, { 
                phrase, 
                translation,
                category, 
                timestamp: new Date().toISOString(),
                contributorId: contributorId,
                contributorName: contributorName
            }).then(() => {
                // Increment the submission count
                const submissionCountRef = ref(db, 'submission_count');
                get(submissionCountRef).then((snapshot) => {
                    const currentCount = snapshot.exists() ? snapshot.val() : 0;
                    const newCount = currentCount + 1;

                    // Update the submission count
                    set(submissionCountRef, newCount)
                        .then(() => {
                            console.log("Submission count updated successfully!");
                        })
                        .catch((error) => {
                            console.error("Error updating submission count:", error);
                        });
                }).catch((error) => {
                    console.error("Error fetching submission count:", error);
                });

                document.getElementById("statusMessage").innerText = "✅ Added, waiting for approval!";
                document.getElementById("newPhrase").value = "";  
                document.getElementById("newTranslation").value = "";
                document.getElementById("newCategory").value = "";
                
                // Clear auto-saved data after successful submission
                clearAutoSavedData();

                // Update the progress bar after successful submission
                updateProgressBar();
                
                // Update contributor leaderboard
                fetchContributorLeaderboard();

                // Show success notification
                showNotification("Translation submitted successfully!", "success");
                
                // Navigate to search tab after successful submission
                document.getElementById('navSearch').click();

                setTimeout(() => {
                    document.getElementById("statusMessage").innerText = "";
                }, 3000);  // Clear the status message after 3 seconds
            }).catch((error) => {
                document.getElementById("statusMessage").innerText = "❌ Error: " + error.message;
                showNotification("Error submitting translation", "error");
            });
        }

        // ==================== FETCH DATA FUNCTIONALITY ====================
        
        // Fetch recent translations
        function fetchRecentTranslations() {
            const recentContainer = document.getElementById("recentTranslations");
            const approvedPhrasesRef = ref(db, 'approved_phrases');
            
            // Query to get the 5 most recent approved phrases
            const recentQuery = query(approvedPhrasesRef, orderByChild('timestamp'), limitToLast(5));
            
            get(recentQuery).then((snapshot) => {
                recentContainer.innerHTML = "<h3>Recently Added</h3>";
                
                if (snapshot.exists()) {
                    // Convert to array and reverse to get newest first
                    const entries = [];
                    snapshot.forEach(childSnapshot => {
                        entries.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Sort by timestamp (newest first) and take the top 3
                    entries.sort((a, b) => {
                        return new Date(b.timestamp || 0) - new Date(a.timestamp || 0);
                    }).slice(0, 3).forEach(entry => {
                        const entryElement = document.createElement("div");
                        entryElement.className = "recent-item";
                        entryElement.innerHTML = `
                            <p><strong>${escapeHTML(entry.phrase)}</strong> → ${escapeHTML(entry.translation)}</p>
                            <span class="recent-date">${formatRelativeTime(entry.timestamp)}</span>
                        `;
                        recentContainer.appendChild(entryElement);
                    });
                } else {
                    recentContainer.innerHTML += "<p>No recent translations available.</p>";
                }
            }).catch((error) => {
                console.error("Error fetching recent translations:", error);
                recentContainer.innerHTML += "<p>❌ Error loading recent translations.</p>";
            });
        }

        // Fetch contributor leaderboard
        function fetchContributorLeaderboard() {
            const leaderboardContainer = document.getElementById("contributorLeaderboard");
            const submissionsRef = ref(db, 'approved_phrases');
            
            get(submissionsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    // Count contributions by contributor ID/name
                    const contributors = {};
                    
                    // System IDs to exclude from leaderboard
                    const systemIds = [
                        'system', 'admin', 'bot', 'initialize', 'initial',
                        'admin_user', 'administrator', 'init_data', 'migration'
                    ];
                    
                    snapshot.forEach(childSnapshot => {
                        const data = childSnapshot.val();
                        
                        // Get contributor name or ID
                        const contributorName = data.contributorName || data.contributor || "Anonymous";
                        const contributorId = data.contributorId || "";
                        
                        // Skip system/admin/initial contributions
                        if (systemIds.some(id => 
                            contributorId.toLowerCase().includes(id) || 
                            contributorName.toLowerCase().includes(id)
                        )) {
                            return; // Skip this iteration
                        }
                        
                        // Skip entries without timestamp (likely initial data)
                        if (!data.timestamp) {
                            return; // Skip this iteration
                        }
                        
                        // Track contributions
                        if (!contributors[contributorName]) {
                            contributors[contributorName] = 0;
                        }
                        
                        contributors[contributorName]++;
                    });
                    
                    // Convert to array and sort
                    const sortedContributors = Object.entries(contributors)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10); // Top 10 contributors
                    
                    // Display leaderboard
                    leaderboardContainer.innerHTML = "<h3>Top Contributors</h3>";
                    
                    if (sortedContributors.length > 0) {
                        const leaderboardList = document.createElement("ol");
                        leaderboardList.className = "leaderboard-list";
                        
                        sortedContributors.forEach(([name, count], index) => {
                            const listItem = document.createElement("li");
                            let medal = "";
                            
                            // Add medals for top 3
                            if (index === 0) medal = "🥇 ";
                            else if (index === 1) medal = "🥈 ";
                            else if (index === 2) medal = "🥉 ";
                            
                            listItem.innerHTML = `
                                <span class="contributor-name">${medal}${escapeHTML(name)}</span>
                                <span class="contribution-count">${count} translation${count !== 1 ? 's' : ''}</span>
                            `;
                            
                            leaderboardList.appendChild(listItem);
                        });
                        
                        leaderboardContainer.appendChild(leaderboardList);
                    } else {
                        leaderboardContainer.innerHTML += "<p>No user contributions yet. Be the first!</p>";
                    }
                } else {
                    leaderboardContainer.innerHTML = "<h3>Top Contributors</h3><p>No contributors yet.</p>";
                }
            }).catch((error) => {
                console.error("Error fetching contributor data:", error);
                leaderboardContainer.innerHTML = "<h3>Top Contributors</h3><p>❌ Error loading contributor data.</p>";
            });
        }

        // ==================== SEARCH FUNCTIONALITY ====================
        
        // Debounce handler
        let debounceTimer;

        // Search phrase in Firebase
        async function searchPhraseInFirebase(searchTerm) {
            if (!searchTerm) {
                document.getElementById("results").innerHTML = ""; // Clear results if no search term
                return [];
            }

            const approvedPhrasesRef = ref(db, 'approved_phrases');
            const searchTermLower = searchTerm.toLowerCase();

            document.getElementById("results").innerHTML = "<p>Loading...</p>"; // Show loading indicator

            try {
                // Parallel queries for approved phrases
                const [snapshotApproved] = await Promise.all([get(approvedPhrasesRef)]);

                const resultsContainer = document.getElementById("results");
                resultsContainer.innerHTML = "";  // Clear previous results

                let exactMatches = [];
                let partialMatches = [];
                
                // Function to process snapshot data
                const processSnapshot = (snapshot) => {
                    snapshot.forEach((childSnapshot) => {
                        const entry = childSnapshot.val();
                        entry.id = childSnapshot.key; // Store the database key
                        
                        const phraseLower = entry.phrase.toLowerCase();
                        const translationLower = entry.translation.toLowerCase();

                        // Check for exact match first
                        if (phraseLower === searchTermLower || translationLower === searchTermLower) {
                            exactMatches.push(entry); // Add exact match
                        }
                        // Check for partial match if no exact match
                        else if (phraseLower.includes(searchTermLower) || translationLower.includes(searchTermLower)) {
                            partialMatches.push(entry); // Add partial match
                        }
                    });
                };

                // Process both snapshots
                if (snapshotApproved.exists()) {
                    processSnapshot(snapshotApproved);
                }

                // Combine exact and partial matches
                const allResults = [...exactMatches, ...partialMatches];

                // Sort results to prioritize exact matches
                allResults.sort((a, b) => {
                    const aIsExact = a.phrase.toLowerCase() === searchTermLower || a.translation.toLowerCase() === searchTermLower;
                    const bIsExact = b.phrase.toLowerCase() === searchTermLower || b.translation.toLowerCase() === searchTermLower;
                    return bIsExact - aIsExact; // Prioritize exact matches (true > false)
                });

                // Display results
                displayResults(allResults, resultsContainer);
                
                return allResults; // Return results
            } catch (error) {
                console.error("Error searching phrase:", error);
                document.getElementById("results").innerHTML = "<p>❌ Error fetching data.</p>";
                return []; // Return empty array on error
            }
        }

        // Debounce search function
        function debounceSearch(event) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchPhraseInFirebase(event.target.value);
            }, 300);  // Wait 300ms after the user stops typing
        }

        // Display search results
        function displayResults(results, container) {
            if (results.length === 0) {
                container.innerHTML = "<p>No matching phrases found.</p>";
                return;
            }
            
            // Clear container
            container.innerHTML = "";
            
            // Limit to 3 results only
            const limitedResults = results.slice(0, 3);
            
            // Display results
            limitedResults.forEach(entry => {
                const resultItem = document.createElement("div");
                resultItem.className = "result-item";
                resultItem.setAttribute("data-id", entry.id);
                
                // Format the result item
                resultItem.innerHTML = `
                    <div class="result-content">
                        <p><strong>${escapeHTML(entry.phrase)}</strong> → ${escapeHTML(entry.translation)}</p>
                        ${entry.category ? `<span class="category-tag">${escapeHTML(entry.category)}</span>` : ''}
                    </div>
                    <div class="result-actions">
                        <button class="copy-button" title="Copy to Clipboard">📋</button>
                    </div>
                `;
                
                container.appendChild(resultItem);
                
                // Add event listener for copy button
                resultItem.querySelector(".copy-button").addEventListener("click", () => {
                    copyToClipboard(`${entry.phrase} - ${entry.translation}`);
                });
                
                // Add text-to-speech button if supported
                if ('speechSynthesis' in window) {
                    const actionsContainer = resultItem.querySelector('.result-actions');
                    
                    // Add TTS button for phrase (Kunama)
                    const ttsButtonPhrase = document.createElement('button');
                    ttsButtonPhrase.className = 'tts-button';
                    ttsButtonPhrase.title = 'Speak Kunama';
                    ttsButtonPhrase.setAttribute('data-text', entry.phrase);
                    ttsButtonPhrase.innerHTML = '🔊 KU';
                    actionsContainer.appendChild(ttsButtonPhrase);
                    
                    // Add TTS button for translation (English)
                    const ttsButtonTrans = document.createElement('button');
                    ttsButtonTrans.className = 'tts-button';
                    ttsButtonTrans.title = 'Speak English';
                    ttsButtonTrans.setAttribute('data-text', entry.translation);
                    ttsButtonTrans.innerHTML = '🔊 EN';
                    actionsContainer.appendChild(ttsButtonTrans);
                    
                    // Add event listeners for TTS buttons
                    ttsButtonPhrase.addEventListener('click', () => {
                        speakText(entry.phrase);
                    });
                    
                    ttsButtonTrans.addEventListener('click', () => {
                        speakText(entry.translation);
                    });
                }
                
                // Add vote buttons
                addVoteButtons(resultItem, entry.id);
            });
            
            // Show total results count if more than 3 results exist
            if (results.length > 3) {
                const moreResultsMessage = document.createElement("p");
                moreResultsMessage.style.marginTop = "10px";
                moreResultsMessage.style.fontStyle = "italic";
                moreResultsMessage.textContent = `Showing top 3 of ${results.length} matching results`;
                container.appendChild(moreResultsMessage);
            }
        }

        // ==================== VOTING FUNCTIONALITY ====================
        
        // Handle vote
        function handleVote(phraseId, voteType) {
            // Reference to the votes in the database
            const voteRef = ref(db, `votes/${phraseId}`);
            
            // Get current vote counts
            get(voteRef).then((snapshot) => {
                let upvotes = 0;
                let downvotes = 0;
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    upvotes = data.upvotes || 0;
                    downvotes = data.downvotes || 0;
                }
                
                // Update votes based on vote type
                if (voteType === 'up') {
                    upvotes++;
                } else if (voteType === 'down') {
                    downvotes++;
                }
                
                // Save updated votes
                set(voteRef, {
                    upvotes,
                    downvotes,
                    score: upvotes - downvotes,
                    timestamp: new Date().toISOString()
                }).then(() => {
                    // Update UI immediately
                    updateVoteDisplay(phraseId, upvotes, downvotes);
                    
                    // Save voted items to localStorage to prevent duplicate votes
                    saveVoteToLocalStorage(phraseId);
                    
                    // Show notification
                    showNotification("Vote recorded!", "success");
                }).catch((error) => {
                    console.error("Error updating votes:", error);
                    showNotification("Error recording vote", "error");
                });
            }).catch((error) => {
                console.error("Error fetching votes:", error);
                showNotification("Error fetching votes", "error");
            });
        }

        // Add vote buttons to search results
        function addVoteButtons(resultItem, phraseId) {
            // Create vote container
            const voteContainer = document.createElement("div");
            voteContainer.className = "vote-container";
            voteContainer.innerHTML = `
                <span class="vote-label">Helpful?</span>
                <button class="vote-button upvote" data-id="${phraseId}">👍 <span class="vote-count">0</span></button>
                <button class="vote-button downvote" data-id="${phraseId}">👎 <span class="vote-count">0</span></button>
            `;
            
            // Append to result item
            resultItem.appendChild(voteContainer);
            
            // Add event listeners
            voteContainer.querySelector(".upvote").addEventListener("click", (e) => {
                if (!hasVoted(phraseId)) {
                    handleVote(phraseId, 'up');
                } else {
                    showVoteMessage(e.target, "You've already voted");
                }
            });
            
            voteContainer.querySelector(".downvote").addEventListener("click", (e) => {
                if (!hasVoted(phraseId)) {
                    handleVote(phraseId, 'down');
                } else {
                    showVoteMessage(e.target, "You've already voted");
                }
            });
            
            // Load current votes
            loadVotes(phraseId);
        }

        // Load current votes from Firebase
        function loadVotes(phraseId) {
            const voteRef = ref(db, `votes/${phraseId}`);
            get(voteRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    updateVoteDisplay(phraseId, data.upvotes || 0, data.downvotes || 0);
                }
            }).catch((error) => {
                console.error("Error loading votes:", error);
            });
        }

        // Update vote display
        function updateVoteDisplay(phraseId, upvotes, downvotes) {
            const resultItem = document.querySelector(`.result-item[data-id="${phraseId}"]`);
            if (resultItem) {
                resultItem.querySelector(".upvote .vote-count").textContent = upvotes;
                resultItem.querySelector(".downvote .vote-count").textContent = downvotes;
            }
        }

        // Save voted items to localStorage
        function saveVoteToLocalStorage(phraseId) {
            const votedItems = JSON.parse(localStorage.getItem("kunama_voted_items") || "[]");
            if (!votedItems.includes(phraseId)) {
                votedItems.push(phraseId);
                localStorage.setItem("kunama_voted_items", JSON.stringify(votedItems));
            }
        }

        // Check if user has already voted
        function hasVoted(phraseId) {
            const votedItems = JSON.parse(localStorage.getItem("kunama_voted_items") || "[]");
            return votedItems.includes(phraseId);
        }

        // Show vote message
        function showVoteMessage(element, message) {
            const messageEl = document.createElement("span");
            messageEl.className = "vote-message";
            messageEl.textContent = message;
            
            element.parentNode.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 2000);
        }

        // ==================== TEXT-TO-SPEECH FUNCTIONALITY ====================
        
        // Speak text
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create a new speech utterance
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Set language based on content
                // Try to detect if it's English or Kunama by checking for common English words
                const commonEnglishWords = ["the", "is", "and", "to", "of", "a", "in", "that", "have", "it"];
                const words = text.toLowerCase().split(/\s+/);
                const containsEnglishWords = words.some(word => commonEnglishWords.includes(word));
                
                // Set language based on detection
                utterance.lang = containsEnglishWords ? 'en-US' : 'und'; // 'und' for undefined/unknown language
                
                // Get available voices
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    // Try to find an appropriate voice
                    if (containsEnglishWords) {
                        // Find an English voice
                        const englishVoice = voices.find(voice => voice.lang.startsWith('en'));
                        if (englishVoice) utterance.voice = englishVoice;
                    }
                }
                
                // Speak the utterance
                window.speechSynthesis.speak(utterance);
                
                // Show notification
                showNotification("Playing audio...");
            } else {
                showNotification("Text-to-speech is not supported in your browser", "error");
            }
        }

        // ==================== DARK MODE FUNCTIONALITY ====================
        
        // Setup dark mode
        function setupDarkMode() {
            // Create dark mode toggle button
            const darkModeToggle = document.createElement("button");
            darkModeToggle.id = "darkModeToggle";
            darkModeToggle.className = "dark-mode-toggle";
            darkModeToggle.title = "Toggle Dark Mode";
            darkModeToggle.innerHTML = "🌓";
            
            // Add to page
            document.querySelector(".container").appendChild(darkModeToggle);
            
            // Check for saved preference
            const darkModeEnabled = localStorage.getItem("kunama_dark_mode") === "true";
            if (darkModeEnabled) {
                document.body.classList.add("dark-mode");
            }
            
            // Toggle dark mode
            darkModeToggle.addEventListener("click", () => {
                document.body.classList.toggle("dark-mode");
                const isDarkMode = document.body.classList.contains("dark-mode");
                localStorage.setItem("kunama_dark_mode", isDarkMode);
            });
        }

        // ==================== ENHANCED FEATURES INITIALIZATION ====================
        
        // Combined Play Navigation setup
        function setupCombinedPlayNavigation() {
            // Only create if necessary
            const navContainer = document.querySelector('.nav-container');
            if (!navContainer || document.getElementById('navPlay')) return;
            
            // Create "Play & Compete" tab as a simple button that opens the quiz section
            const playTab = document.createElement('div');
            playTab.id = 'navPlay';
            playTab.className = 'nav-item';
            playTab.textContent = 'Play & Compete';
            
            // Add click handler
            playTab.addEventListener('click', () => {
                // Show the quiz section
                document.querySelectorAll('.nav-item').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
                
                playTab.classList.add('active');
                document.getElementById('quizSection').classList.add('active');
            });
            
            // Find position to insert (before leaderboard or at the end)
            const leaderboardTab = document.getElementById('navLeaderboard');
            if (leaderboardTab) {
                navContainer.insertBefore(playTab, leaderboardTab);
            } else {
                navContainer.appendChild(playTab);
            }
        }
        
        // Initialize enhanced features
        function initEnhancedFeatures() {
            try {
                // Initialize features that might not be fully implemented yet
                setupCombinedPlayNavigation();
                
                // Initialize support for Firebase onValue if it's available
                if (typeof onValue === 'undefined') {
                    // Create a fallback for onValue if it's not available
                    window.onValue = function(reference, callback) {
                        // This is a simplified fallback that just does a one-time get
                        get(reference).then(snapshot => {
                            callback(snapshot);
                        }).catch(error => {
                            console.error("Error in onValue fallback:", error);
                        });
                        
                        // Return a no-op function as unsubscribe
                        return function() {};
                    };
                }
            } catch (error) {
                console.error("Error in enhanced features initialization:", error);
            }
        }

        // ==================== EVENT LISTENERS SETUP ====================
        
        // Setup event listeners
        function setupEventListeners() {
            // Search input event
            document.getElementById("searchInput").addEventListener("input", debounceSearch);

            // Add phrase button
            document.getElementById("addPhraseButton").addEventListener("click", () => {
                const phrase = document.getElementById("newPhrase").value.trim();
                const translation = document.getElementById("newTranslation").value.trim();
                const category = document.getElementById("newCategory").value;
                
                if (phrase && translation) {
                    confirmSubmission(phrase, translation, category, () => {
                        addNewPhraseToFirebase(phrase, translation, category);
                    });
                } else {
                    showNotification("Please enter both phrase and translation", "error");
                }
            });
            
            // Close auth modal when clicking outside
            document.getElementById("authModal").addEventListener("click", (e) => {
                if (e.target === document.getElementById("authModal")) {
                    hideAuthModal();
                }
            });
            
            // Add keyboard event listener to close modals with Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    // Hide auth modal
                    if (document.getElementById("authModal").style.display === "flex") {
                        hideAuthModal();
                    }
                    
                    // Hide profile section
                    if (document.getElementById("userProfileSection").style.display === "block") {
                        document.getElementById("userProfileSection").style.display = "none";
                    }
                }
            });
            
            // Submit auth forms on Enter key
            document.getElementById("signinPassword").addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    document.getElementById("signinBtn").click();
                }
            });
            
            document.getElementById("signupPassword").addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    document.getElementById("signupBtn").click();
                }
            });
        }

        // ==================== APPLICATION INITIALIZATION ====================
        
        // Initialize application
        window.onload = function() {
            try {
                // Create a placeholder anonymous user ID for app functionality
                if (!localStorage.getItem("kunama_contributor_id")) {
                    const contributorId = "anonymous_" + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem("kunama_contributor_id", contributorId);
                }
                
                // Setup navigation
                setupNavigation();
                
                // Setup quiz functionality
                window.startQuiz = startQuiz;
                window.checkAnswer = checkAnswer;
                window.nextQuestion = nextQuestion;
                window.setDifficulty = setDifficulty;
                
                // Load high score for quiz
                highScore = localStorage.getItem('kunamaQuizHighScore') || 0;
                document.getElementById('highScoreValue').innerText = `${highScore}%`;
                
                // Set default quiz difficulty
                setDifficulty('medium');
                
                // Setup base functionality
                setupEventListeners();
                updateProgressBar();
                setupCharacterCounters();
                setupAutoSave();
                setupDarkMode();
                
                // Fetch data
                fetchRecentTranslations();
                fetchContributorLeaderboard();
                
                // Setup authentication
                setupAuthentication();
                
                // Initialize enhanced features
                initEnhancedFeatures();
                
                // Expose multiplayer functions to window for button click handlers
                window.copyGameCode = copyGameCode;
                window.resumeGame = resumeGame;
                window.abandonGame = abandonGame;
                
                // Load available voices for TTS (some browsers need this)
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.onvoiceschanged = function() {
                        // Voices loaded
                        const voices = window.speechSynthesis.getVoices();
                        console.log(`Loaded ${voices.length} voices for speech synthesis`);
                    };
                }
                
                console.log("Application initialization completed successfully.");
            } catch (error) {
                console.error("Error during application initialization:", error);
                showNotification("There was a problem initializing the application. Please refresh the page.", "error");
            }
        };
    </script>
</body>
</html>
